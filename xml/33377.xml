<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article  PUBLIC "-//NLM//DTD Journal Publishing DTD v3.0 20080202//EN" "http://dtd.nlm.nih.gov/publishing/3.0/journalpublishing3.dtd"><article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="3.0" xml:lang="en" article-type="research article"><front><journal-meta><journal-id journal-id-type="publisher-id">SEA</journal-id><journal-title-group><journal-title>Software Engineering and Applications</journal-title></journal-title-group><issn pub-type="epub">2325-2286</issn><publisher><publisher-name>Scientific Research Publishing</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="doi">10.12677/SEA.2019.86041</article-id><article-id pub-id-type="publisher-id">SEA-33377</article-id><article-categories><subj-group subj-group-type="heading"><subject>SEA20190600000_69155726.pdf</subject></subj-group><subj-group subj-group-type="Discipline-v2"><subject>工程技术</subject></subj-group></article-categories><title-group><article-title>
 
 
  基于EtherCAT高速数据总线的烟雾报警系统
  Smoke Alarm System Based on EtherCAT High Speed Data Bus
 
</article-title></title-group><contrib-group><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>吴</surname><given-names>超</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="corresp" rid="cor1"><sup>*</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>王</surname><given-names>成群</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>徐</surname><given-names>伟强</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>朱</surname><given-names>升宏</given-names></name><xref ref-type="aff" rid="aff3"><sup>3</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>贾</surname><given-names>宇波</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref></contrib></contrib-group><aff id="aff1"><addr-line>浙江理工大学信息学院，浙江 杭州</addr-line></aff><aff id="aff3"><addr-line>新华三技术有限公司，浙江 杭州</addr-line></aff><aff id="aff2"><addr-line>null</addr-line></aff><pub-date pub-type="epub"><day>22</day><month>11</month><year>2019</year></pub-date><volume>08</volume><issue>06</issue><fpage>334</fpage><lpage>340</lpage><permissions><copyright-statement>&#169; Copyright  2014 by authors and Scientific Research Publishing Inc. </copyright-statement><copyright-year>2014</copyright-year><license><license-p>This work is licensed under the Creative Commons Attribution International License (CC BY). http://creativecommons.org/licenses/by/4.0/</license-p></license></permissions><abstract><p>
 
 
  在分析EtherCAT通信协议的基础上，设计了一种基于EtherCAT高速数据总线的烟雾报警系统。EtherCAT从站使用FPGA芯片代替国外专用控制芯片实现EtherCAT协议飞读飞写功能，EtherCAT主站将每个从站报警信息实时上报显示。实验结果表明采用EtherCAT总线技术组网避免了基于无极性二线制数据总线的烟雾检测系统难以接入工业物联网的问题，具有成本低、性能可靠等特点。
   Based on the analysis of EtherCAT communication protocol, a smoke alarm system based on Ether-CAT high-speed data bus is designed. The EtherCAT slave station uses the FPGA chip instead of the foreign special control chip to realize “on the fly” function of the EtherCAT protocol. The EtherCAT master station will report and display the alarm information of each slave station in real time. The experimental results show that the networking technology of EtherCAT bus avoids the problem that it is difficult for smoke detection system based on non-polar two-wire data bus to access to the industrial Internet of Things. It has the characteristics of low cost and reliable performance.
 
</p></abstract><kwd-group><kwd>工业以太网，EtherCAT，FPGA，烟雾报警, Industrial Ethernet</kwd><kwd> EtherCAT</kwd><kwd> FPGA</kwd><kwd> Smoke Alarm</kwd></kwd-group></article-meta></front><body><sec id="s1"><title>基于EtherCAT高速数据总线的烟雾报警系统<sup> </sup></title><p>吴超<sup>1</sup>，王成群<sup>1</sup>，徐伟强<sup>1</sup>，朱升宏<sup>2</sup>，贾宇波<sup>1</sup></p><p><sup>1</sup>浙江理工大学信息学院，浙江 杭州</p><p><sup>2</sup>新华三技术有限公司，浙江 杭州</p><p><img src="//html.hanspub.org/file/8-2690396x1_hanspub.png" /></p><p>收稿日期：2019年11月19日；录用日期：2019年12月3日；发布日期：2019年12月10日</p><disp-formula id="hanspub.33377-formula86"><graphic xlink:href="//html.hanspub.org/file/8-2690396x5_hanspub.png"  xlink:type="simple"/></disp-formula></sec><sec id="s2"><title>摘 要</title><p>在分析EtherCAT通信协议的基础上，设计了一种基于EtherCAT高速数据总线的烟雾报警系统。EtherCAT从站使用FPGA芯片代替国外专用控制芯片实现EtherCAT协议飞读飞写功能，EtherCAT主站将每个从站报警信息实时上报显示。实验结果表明采用EtherCAT总线技术组网避免了基于无极性二线制数据总线的烟雾检测系统难以接入工业物联网的问题，具有成本低、性能可靠等特点。</p><p>关键词 :工业以太网，EtherCAT，FPGA，烟雾报警</p><disp-formula id="hanspub.33377-formula87"><graphic xlink:href="//html.hanspub.org/file/8-2690396x6_hanspub.png"  xlink:type="simple"/></disp-formula><p>Copyright &#169; 2019 by author(s) and Hans Publishers Inc.</p><p>This work is licensed under the Creative Commons Attribution International License (CC BY).</p><p>http://creativecommons.org/licenses/by/4.0/</p><p><img src="//html.hanspub.org/file/8-2690396x7_hanspub.png" /> <img src="//html.hanspub.org/file/8-2690396x8_hanspub.png" /></p></sec><sec id="s3"><title>1. 引言</title><p>随着工业4.0的提出，实时以太网凭借其成熟的特性与工业自动化结合的更为紧密，成为该领域不可或缺的技术。EtherCAT (Ethernet for Control Automation Technology)作为高性能工业以太网的代表，以其延迟低、速率快、拓扑灵活等优点得到国内外许多专家、学者和企业的关注，已经成为工业控制领域流行的工业以太网解决方式 [<xref ref-type="bibr" rid="hanspub.33377-ref1">1</xref>] [<xref ref-type="bibr" rid="hanspub.33377-ref2">2</xref>] [<xref ref-type="bibr" rid="hanspub.33377-ref3">3</xref>]。</p><p>目前生产车间存在由于工人误操作或被测对象故障等原因引起线路烧毁等安全隐患。</p><p>传统的消防类烟雾检测系统在组网时一般采用无极性二线制编码方式组网，系统相对独立，网络带宽低，难以接入工业物联网，已经不能满足智能工厂建设环节的需求，而针对工业物联网设计的烟雾检测传感器成本又相对较高 [<xref ref-type="bibr" rid="hanspub.33377-ref4">4</xref>] [<xref ref-type="bibr" rid="hanspub.33377-ref5">5</xref>] [<xref ref-type="bibr" rid="hanspub.33377-ref6">6</xref>]。</p><p>本文针对这种情况，提出一种将技术成熟、成本低、应用广泛的消防类烟雾检测传感器融入EtherCAT网络的设计方案。本设计中使用FPGA芯片代替国外专用控制器芯片完成EtherCAT从站设计，EtherCAT主站则是作为协议转换器接入网络，将每个从站烟雾报警信息上报给应用服务器。这样就可以在数据终端实时监测生产车间每个烟雾报警器的运行状况。</p></sec><sec id="s4"><title>2. EtherCAT协议帧结构</title><p>EtherCAT帧结构遵循IEEE802.3标准，使用保留的帧类型0x88A4来区别于其它以太网帧。多个子报文被无间隙的打包到一个以太网帧中。每个从站在数据帧经过时根据子报文头中的寻址地址判断是否</p><p>图1. EtherCAT 数据帧结构</p><p>自己是目标从站，根据子报文中命令判断是读取还是插入数据或者是二者都需要执行 [<xref ref-type="bibr" rid="hanspub.33377-ref7">7</xref>] [<xref ref-type="bibr" rid="hanspub.33377-ref8">8</xref>]。一个EtherCAT子报文有三部分组成：子报文头、子报文数据、工作计数器WKC。子报文头中包含一些关键信息，包括寻址地址、读写命令、子报文长度等。子报文数据区存储的则是用户数据，WKC的作用是主站判断子报文有没有被对应从站正确处理 [<xref ref-type="bibr" rid="hanspub.33377-ref9">9</xref>] [<xref ref-type="bibr" rid="hanspub.33377-ref10">10</xref>] [<xref ref-type="bibr" rid="hanspub.33377-ref11">11</xref>]。EtherCAT报文既可以按照标准以太网帧传输，也可以封装在UDP/IP数据帧中进行传输。EtherCAT数据帧结构如图1所示。</p></sec><sec id="s5"><title>3. 基于EtherCAT烟雾报警系统架构</title><p>基于EtherCAT的烟雾报警系统框架如图2所示，整个系统可以实现一主多从的EtherCAT通讯，主从站之间采用线性拓扑的连接方式。该烟雾报警系统主要包括三大模块：电流型烟雾检测传感器接入、网络传输控制系统和报警系统。烟雾检测传感器接入包括传感器供电、状态检测、报警信号检测和传感器状态硬件重置；网络传输控制系统包括基于EtherCAT总线技术的传输协议帧设计、终端节点数目的实时获取、网络拓扑结构的实时获取和烟雾检测传感器状态的实时上报；报警系统包括烟雾检测传感器终端的声光报警、EtherCAT主站的声光报警和报警信息的实时上报与显示。</p><p>图2. 烟雾报警系统架构</p><sec id="s5_1"><title>3.1. 烟感报警系统从站通讯协议设计</title><p>本设计从站通讯协议中主要包含三种报文类型：初始化报文、广播报文、普通子报文。初始化报文主要用于终端节点数目和网络拓扑结构的实时获取，广播报文实现报警状态的解除，普通子报文实现烟雾检测传感器状态的实时上报。从站完全处于被动模式，只有主站发送命令后从站才响应，从站不主动向主站发送任何信息。主站发送广播报文则每个从站都要接收该广播报文，而主站发送普通子报文时则只有对应从站处理相应报文。本设计在不使用专用从站控制器的情况下，使用FPGA芯片实现EtherCAT协议中的“on the fly”技术，每个从站在报文经时读出属于自己的报文，同时将要发送出去的数据插入报文中转发给下一个从站。由于主要工作都由硬件实现可以大大降低传输的延时，提高了网络的实时性。将EtherCAT从站通讯协议分为两个模块：从站初始化模块、从站控制器模块。</p><p>1) 从站初始化模块</p><p>从站初始化模块主要在系统启动阶段工作，此时每个从站会从ARM处获得自己的ID编号。同时会启动自检流程，判断网络拓扑结构 [<xref ref-type="bibr" rid="hanspub.33377-ref12">12</xref>]。当接收到EtherCAT主站发送的初始化报文后需要将报文中的从站个数计数器加1后发送给下一个从站，最后一个从站将处理后的报文在返回给上一个从站，直至传回给主站。烟感报警系统的拓扑结构如图3所示。</p><p>图3. 烟感报警系统拓扑结构</p><p>2) 从站控制器模块</p><p>从站控制器模块主要是在系统启动后执行报文解析功能，一旦检测到有上行报文发送过来就暂存所有数据。首先判断是否是空帧，如果是空帧则判断是否有报警信息需要发送，如果有则组成标准EtherCAT子报文插入EtherCAT协议数据区，没有则直接转发给下一个从站。如果不是空帧则取出一个子报文判断其类型，如果是广播帧就将广播帧数据发给ARM，并判断ARM是否有报警信息需要发送，如果有则组成标准EtherCAT子报文插在广播帧之后发给下一个从站，如果没有报警信息则直接将广播帧转发给下一个从站。如果是普通帧则判断子报文中寻址ID是否是当前从站，如果是就将子报文数据取出发给ARM。如果不是则继续判断下一帧数据，直至取出所有子报文后判断ARM是否有报警信息，如果有则组成标准EtherCAT子报文插入到所有子报文之后发送给下一个从站，如果没有则直接转发给下一个从站。通过这样的方式就可以实现对每个从站数据的飞读飞写功能。EtherCAT从站报文解析流程如图4所示。</p></sec><sec id="s5_2"><title>3.2. 烟感报警系统主站通讯协议设计</title><p>EtherCAT主站在初始化阶段也会向ARM索要主站ID、主站MAC地址、主站IP地址、服务器Mac地址、服务器IP地址等参数。参数配置完毕后启动自检流程，发送初始化帧判断系统中有多少个EtherCAT从节点。在数据发送接收阶段，判断ARM是否有广播报文或普通子报文发送，如果没有则发送空帧去携带下行从站的烟雾报警信息，接收到报警信息后主站发出声光报警并通过UDP协议上报给应用服务器，实现报警信息的远程查看。</p></sec></sec><sec id="s6"><title>4. 硬件平台设计</title><p>为了验证基于EtherCAT现场总线的烟雾报警系统的可行性，搭建了如图5所示的硬件平台。这个硬件平台既可以作为EtherCAT主站，也可以作为EtherCAT从站使用。FPGA选用的是Altera公司CycloneIV系列的芯片EP4CE6E22C8N，工作频率为50 M。ARM芯片选用的是NXP公司的Cortex_M3，工作频率是100 M。百兆以太网的晶振频率是25 M，FPGA芯片与百兆以太网之间采用MII接口协议。</p></sec><sec id="s7"><title>5. 系统测试</title><p>为了验证本文设计的烟雾报警系统是否可以执行预期的功能，搭建了如图6所示的测试平台。这里选择1个主站和5个从站来验证基于EtherCAT高速数据总线的烟雾报警系统的可靠性。具体做法为：先在第四个从站传感器处产生烟雾，解除报警后在第五个从站传感器处产生烟雾，控制终端结果如图7所示。其中1A、1B、2A、2B、3A代表5个EtherCAT从站，绿色代表运行正常，红色代表产生报警信息。多次实验结果表明该报警系统准确可靠，实时性好，易于管理。</p><p>图4. 从站报文解析流程图</p><p>图5. EtherCAT主控板</p><p>图6. 测试平台</p><p>图7. 实验结果</p></sec><sec id="s8"><title>6. 结束语</title><p>针对传统消防类烟雾检测系统检测传感器成本高、难以接入工业物联网的问题，提出一种基于EtherCAT高速数据总线的烟雾报警系统。本设计使用FPGA芯片代替专用控制芯片完成EtherCAT主从站设计。通过实验验证该系统具有稳定可靠、成本低、易于接入工业物联网等特点。</p></sec><sec id="s9"><title>基金项目</title><p>浙江省重点研发计划资助项目(No.2018C01093)。</p></sec><sec id="s10"><title>文章引用</title><p>吴 超,王成群,徐伟强,朱升宏,贾宇波. 基于EtherCAT高速数据总线的烟雾报警系统Smoke Alarm System Based on EtherCAT High Speed Data Bus[J]. 软件工程与应用, 2019, 08(06): 334-340. https://doi.org/10.12677/SEA.2019.86041</p></sec><sec id="s11"><title>参考文献</title></sec></body><back><ref-list><title>References</title><ref id="hanspub.33377-ref1"><label>1</label><mixed-citation publication-type="other" xlink:type="simple">Sommer, J., Gunreben, S., Feller, F., et al. (2010) Ethernet—A Survey on Its Fields of Application. IEEE Communica-tions Surveys &amp; Tutorials, 12, 263-284. &lt;br&gt;https://doi.org/10.1109/SURV.2010.021110.00086</mixed-citation></ref><ref id="hanspub.33377-ref2"><label>2</label><mixed-citation publication-type="other" xlink:type="simple">Gaj, P., Jasper-neite, J. and Felser, M. (2013) Computer Communication within Industrial Distributed Environment—A Survey. IEEE Transactions on Industrial Informatics, 9, 182-189. &lt;br&gt; https://doi.org/10.1109/TII.2012.2209668</mixed-citation></ref><ref id="hanspub.33377-ref3"><label>3</label><mixed-citation publication-type="other" xlink:type="simple">Danielis, P., Skodzik, J., Altmann, V., et al. (2014) Survey on Real-Time Communication via Ethernet in Industrial Automation Environments. Proceedings of the 2014 IEEE Emerging Technology and Factory Automation (ETFA), Barcelona, 16-19 September 2014, 1-8. &lt;br&gt;https://doi.org/10.1109/ETFA.2014.7005074</mixed-citation></ref><ref id="hanspub.33377-ref4"><label>4</label><mixed-citation publication-type="other" xlink:type="simple">吴哲夫, 唐万利, 陈骋, 方路平. 基于Wi-Fi的烟雾实时检测方法[J]. 电信科学, 2019, 35(6): 70-77.</mixed-citation></ref><ref id="hanspub.33377-ref5"><label>5</label><mixed-citation publication-type="other" xlink:type="simple">冯宪周, 张宏, 李玉峰. 基于DSP的视频烟雾探测器设计[J]. 船海工程, 2018, 47(6): 29-31.</mixed-citation></ref><ref id="hanspub.33377-ref6"><label>6</label><mixed-citation publication-type="other" xlink:type="simple">孙波, 刘士彩, 王玉潇, 张家迎, 高学辉, 郭帅. 基于STM32F103单片机的烟雾报警器设计[J]. 电子世界, 2018(20): 132-133.</mixed-citation></ref><ref id="hanspub.33377-ref7"><label>7</label><mixed-citation publication-type="other" xlink:type="simple">Huang, Y.W. and Wu, C.H. (2014) Design and Implementation of EtherCAT Slave Based on ARM Cortex-Mo. In: Juang, J., Chen C.Y. and Yang C.F., Eds., Proceedings of the 2nd International Conference on Intelligent Technologies and Engineering Systems (ICITES2013), Springer, Cham, 741-747. &lt;br&gt;https://doi.org/10.1007/978-3-319-04573-3_92</mixed-citation></ref><ref id="hanspub.33377-ref8"><label>8</label><mixed-citation publication-type="other" xlink:type="simple">Kang, C., Pang, Y., Ma, C., et al. (2011) Design of EtherCAT Slave Module. 2011 IEEE International Conference on Mechatronics and Automation, Beijing, 7-10 August 2011, 1600-1604. &lt;br&gt;https://doi.org/10.1109/ICMA.2011.5985953</mixed-citation></ref><ref id="hanspub.33377-ref9"><label>9</label><mixed-citation publication-type="other" xlink:type="simple">蒲婉玲. EtherCAT 主站与从站设计与实现[D]: [硕士学位论文]. 成都: 电子科技大学, 2018.</mixed-citation></ref><ref id="hanspub.33377-ref10"><label>10</label><mixed-citation publication-type="other" xlink:type="simple">杨勇军. 基于EtherCAT工业以太网协议主从站设计[D]: [硕士学位论文]. 湘潭: 湘潭大学, 2017年.</mixed-citation></ref><ref id="hanspub.33377-ref11"><label>11</label><mixed-citation publication-type="other" xlink:type="simple">苏印红, 张爱军, 孙琳, 江磊. 基于EtherCAT的多轴伺服系统设计研究[J]. 电子设计工程, 2019, 27(14): 40-44.</mixed-citation></ref><ref id="hanspub.33377-ref12"><label>12</label><mixed-citation publication-type="other" xlink:type="simple">Knezic, M., Dokic, B. and Ivanovic, Z. (2010) Topology Aspects in EtherCAT Networks. Proceedings of 14th International Power Electronics and Motion Control Conference EPE-PEMC 2010, Ohrid, 6-8 September 2010, T1-1-T1-6. &lt;br&gt;https://doi.org/10.1109/EPEPEMC.2010.5606688</mixed-citation></ref></ref-list></back></article>