<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article  PUBLIC "-//NLM//DTD Journal Publishing DTD v3.0 20080202//EN" "http://dtd.nlm.nih.gov/publishing/3.0/journalpublishing3.dtd"><article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="3.0" xml:lang="en" article-type="research article"><front><journal-meta><journal-id journal-id-type="publisher-id">CSA</journal-id><journal-title-group><journal-title>Computer Science and Application</journal-title></journal-title-group><issn pub-type="epub">2161-8801</issn><publisher><publisher-name>Scientific Research Publishing</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="doi">10.12677/CSA.2017.79102</article-id><article-id pub-id-type="publisher-id">CSA-22169</article-id><article-categories><subj-group subj-group-type="heading"><subject>CSA20170900000_22143154.pdf</subject></subj-group><subj-group subj-group-type="Discipline-v2"><subject>信息通讯</subject></subj-group></article-categories><title-group><article-title>
 
 
  基于STM32和CAN总线的全向移动平台控制系统设计
  Design of Omnidirectional Mobile Platform Control System Based on STM32 CAN Bus Control
 
</article-title></title-group><contrib-group><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>彭</surname><given-names>思淇</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>田</surname><given-names>林晓</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>王</surname><given-names>妍</given-names></name><xref ref-type="aff" rid="aff3"><sup>3</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>廖</surname><given-names>明</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>肖</surname><given-names>志兰</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>张</surname><given-names>克华</given-names></name><xref ref-type="aff" rid="aff3"><sup>3</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib></contrib-group><aff id="aff3"><addr-line>浙江师范大学工学院，浙江 金华 </addr-line></aff><aff id="aff2"><addr-line>浙江师范大学工学院，浙江 金华</addr-line></aff><aff id="aff1"><addr-line>null</addr-line></aff><pub-date pub-type="epub"><day>31</day><month>08</month><year>2017</year></pub-date><volume>07</volume><issue>09</issue><fpage>894</fpage><lpage>901</lpage><permissions><copyright-statement>&#169; Copyright  2014 by authors and Scientific Research Publishing Inc. </copyright-statement><copyright-year>2014</copyright-year><license><license-p>This work is licensed under the Creative Commons Attribution International License (CC BY). http://creativecommons.org/licenses/by/4.0/</license-p></license></permissions><abstract><p>
 
 
   
   全向移动平台采用多个麦克纳姆轮独立驱动，通过轮组的转速和转向的组合，可以以任意姿态在二维平面内移动，运动非常灵活、平稳，通过位置细微调整实现精确定位和高精度轨迹控制，广泛用于自主移动机器人。为了提高全向移动平台控制的实时性和精确性，增强整个控制系统的稳定性与准确性，对该平台所采用的CAN总线网络、DMA数据传输和PID控制算法等方法进行研究。首先对基于麦克纳姆轮的移动平台进行数学建模并进行运动分析，然后为了加快传感器数据的传输，采用DMA数据传输，而且主控和电机之间通过CAN总线网络以1 M/S的速度进行数据交换。经过测试，在遥控平台全向运动的过程中，操作流畅，平台无卡顿现象，并能够快速准确的到达目标位置。满足控制系统的稳定可靠、精度高、抗干扰能力强等要求。 Omnidirectional mobile platform is driven by independent multiple Mecanum wheels. Through the combination of rotation speed and steering of the wheel set, it can move in a two-dimensional plane at arbitrary angles. Its movement is very flexible and smooth. It implements precise positioning and high precision trajectory control with fine adjustment of position, and is widely used in autonomous mobile robots. To improve the real-time and accuracy of omnidirectional mobile platform and enhance the stability and accuracy of the whole control system, the CAN bus network used in the platform, DMA data transmission, PID control and other methods were studied. Firstly, the mathematical modeling and motion analysis of the mobile platform based on the Mecanum wheel is carried out. Then, to speed up the transmission of sensor data, the platform uses DMA data transmission, and data exchange between main control and motor through CAN bus network is carried out at the speed of 1 M/S. Through repeated debugging and testing, operation is smooth during omnidirectional movement of the remote-control platform. And the platform without lag phenomenon, can quickly and accurately reach the target position. It basically meets the requirements of stable, reliable, high precision and strong anti-interference ability of the control system. 
 
 
</p></abstract><kwd-group><kwd>全向移动平台，CAN总线，DMA，PID算法, Omnidirectional Mobile Platform</kwd><kwd> CAN Bus Network</kwd><kwd> DMA</kwd><kwd> PID Algorithm</kwd></kwd-group></article-meta></front><body><sec id="s1"><title>基于STM32和CAN总线的全向移动平台 控制系统设计<sup> </sup></title><p>彭思淇，田林晓，王妍，廖明，肖志兰，张克华<sup>*</sup></p><p>浙江师范大学工学院，浙江 金华</p><disp-formula id="hanspub.22169-formula3"><graphic xlink:href="//html.hanspub.org/file/11-1540843x5_hanspub.png"  xlink:type="simple"/></disp-formula><p>收稿日期：2017年9月10日；录用日期：2017年9月23日；发布日期：2017年9月27日</p><disp-formula id="hanspub.22169-formula4"><graphic xlink:href="//html.hanspub.org/file/11-1540843x6_hanspub.png"  xlink:type="simple"/></disp-formula></sec><sec id="s2"><title>摘 要</title><p>全向移动平台采用多个麦克纳姆轮独立驱动，通过轮组的转速和转向的组合，可以以任意姿态在二维平面内移动，运动非常灵活、平稳，通过位置细微调整实现精确定位和高精度轨迹控制，广泛用于自主移动机器人。为了提高全向移动平台控制的实时性和精确性，增强整个控制系统的稳定性与准确性，对该平台所采用的CAN总线网络、DMA数据传输和PID控制算法等方法进行研究。首先对基于麦克纳姆轮的移动平台进行数学建模并进行运动分析，然后为了加快传感器数据的传输，采用DMA数据传输，而且主控和电机之间通过CAN总线网络以1 M/S的速度进行数据交换。经过测试，在遥控平台全向运动的过程中，操作流畅，平台无卡顿现象，并能够快速准确的到达目标位置。满足控制系统的稳定可靠、精度高、抗干扰能力强等要求。</p><p>关键词 :全向移动平台，CAN总线，DMA，PID算法</p><disp-formula id="hanspub.22169-formula5"><graphic xlink:href="//html.hanspub.org/file/11-1540843x7_hanspub.png"  xlink:type="simple"/></disp-formula><p>Copyright &#169; 2017 by authors and Hans Publishers Inc.</p><p>This work is licensed under the Creative Commons Attribution International License (CC BY).</p><p>http://creativecommons.org/licenses/by/4.0/</p><p><img src="http://image.hanspub.org:8080\Html/htmlimages\1-2890033x\e70a10f1-7c93-45ea-9603-062237856e4b.png" /><img src="http://image.hanspub.org:8080\Html\htmlimages\1-2890033x\e898c85e-ffc4-45c9-b817-14224a4d6960.png" /></p></sec><sec id="s3"><title>1. 引言</title><p>机器人技术作为一种高新技术，将计算机技术，人工智能，传感器技术，控制论等多学科综合在一起，是科学技术发展共同的一个综合性的科学成果。而且移动机器人平台是机器人学的一个重要分支，是一种由运动控制器系统、信息采集系统、机械装置所组成的具有人工智能的控制系统 [<xref ref-type="bibr" rid="hanspub.22169-ref1">1</xref>] 。相比于传统的移动平台，全向移动平台在空间有限、狭窄、对机动性要求较高的场合有着明显的优势，因此已经得到了广泛的应用，比如装配生产行业，仓储物流行业，交通工具等等。</p><p>自从1973年瑞士人Bengt Lion发明了Mecanum轮后，因其承载能力强，通过各轮之间转速转向的配合即可实现全方位移动而广泛的应用在移动平台上，更加的贴近于实际应用。譬如德国KUKA公司研发的基于Mecanum轮平台的五轴机械臂youBot机器人；美国AirTrax公司将Mecanum轮的全向移动平台进行了商业化，产品有Sidewinder系列万向行走叉车、COBRA系列升降平台、MP2系列平板拖车等；德国MIAG公司生产的Mecanum轮式弹体搬运转载车等等。如图1所示。</p><p>目前国内Mecanum轮式全向移动平台的应用广泛，但主要为运动的实现或者以全向移动为基础的多种功能的混合实现，而对于平台的移动精度，实时性以及平稳性的研究还不够完善 [<xref ref-type="bibr" rid="hanspub.22169-ref2">2</xref>] 。为了提高全向移动平台的实时性和精确性，增强整个控制系统的稳定性与准确性，更好的协调各个传感器之间的通信，引入分布式实时控制的CAN总线技术，并利用DMA进行遥控数据的传输测试。</p><p>本文首先对移动平台的硬件构成做了简要介绍，并对平台进行运动分析。再利用软件流程图的方式简单说明了整个控制系统的工作流程。然后重点阐述了CAN总线通信的实现和遥控数据的DMA传输。</p><p>图1. 全向移动平台应用实例</p><p>最终对平台进行实地测试，达到预期目的。</p></sec><sec id="s4"><title>2. 移动平台系统的构成及运动分析</title><sec id="s4_1"><title>2.1. 全向移动平台系统的硬件构成</title><p>全向移动平台的整个系统是基于CAN总线搭建的，主控STM32和各个电机驱动做为通信节点接入CAN总线，遥控系统由遥控器和接收机组成。整个平台框架结构原理图如图2所示。</p><p>平台使用STM32F407芯片作为控制系统的主控。该芯片采用了先进的Cortex_M4内核，拥有强大的浮点计算以及处理DSP指令的能力；并且拥有高达1 M字节的片上闪存和196 K字节的内嵌SRAM；同时可以以168 Mhz高速运行时可达到210DMIPS的处理能力，以及丰富的外设都为系统的可靠性提供了更好的保障。</p></sec><sec id="s4_2"><title>2.2. 移动平台运动分析</title><p>如图3所示，左边的图是以整车作为一个坐标系，右边的图是以轮1作为一个坐标系。4个电机分别驱动4个麦克纳姆轮，实现独立旋转。摩擦力的方向由辊子的安装角度以及转动的方向决定。假设4个麦轮的转动速度为w<sub>1</sub>，w<sub>2</sub>，w<sub>3</sub>，w<sub>4</sub>；整车的速度为v<sub>x</sub>，v<sub>y</sub>，v<sub>0</sub>；辊子的速度v<sub>g</sub><sub>1</sub>，v<sub>g</sub><sub>2</sub>，v<sub>g</sub><sub>3</sub>，v<sub>g</sub><sub>4</sub>。以轮1为例，O为底盘的中心，O<sub>1</sub>为轮1的中心。XOY为与车体运动中心固联的直角坐标系，X<sub>1</sub>O<sub>1</sub>Y<sub>1</sub>为与轮毂中心固联的直角坐标系。</p><p>在XOY坐标系下，轮1中心点O<sub>1</sub>的移动速度为：</p><p>v O 1 x = v x − w 0 L 1 (1)</p><p>v O 1 y = v y − w 0 L 2 (2)</p><p>在X<sub>1</sub>O<sub>1</sub>Y<sub>1</sub>坐标系下，轮1中心O<sub>1</sub>点的移动速度为：</p><p>v O 1 x = − v g 1 cos α + w 1 R (3)</p><p>v O 1 y = v g 1 sin α (4)</p><p>其中 v O 1 x 为轮1沿x方向移动速度，其中 v O 1 y 为轮1沿y方向移动速度， v g 1 为棍子1的转速。综合式(1)，式(2)，式(3)，式(4)可得：</p><p>{ v x − w 0 L 1 = − v g 1 cos α + w 1 R v y − w 0 L 2 = − v g 1 sin α (5)</p><p>图2. 框架结构原理图</p><p>图3. 车体坐标系以及轮1坐标系</p><p>将式(5)联立求得轮1的转速为：</p><p>w 1 = 1 R [ 1 1 tan α − ( L 1 + L 2 tan α ) ] [ v x v y w 0 ] (6)</p><p>又因为棍子的安装角度为45度，化简得：</p><p>w 1 = 1 R [ 1 1 − ( L 1 + L 2 ) ] [ v x v y w 0 ] (7)</p><p>同理分析其余3个轮子，可得：</p><p>[ w 1 w 2 w 3 w 4 ] = 1 R [ 1 1 − ( L 1 + L 2 ) 1 − 1 ( L 1 + L 2 ) 1 − 1 − ( L 1 + L 2 ) 1 1 ( L 1 + L 2 ) ] [ v x v y w 0 ] (8)</p><p>由式(8)知，分配给四个轮子的转速和旋转方向不同，平台就可以实现全方位移动 [<xref ref-type="bibr" rid="hanspub.22169-ref3">3</xref>] [<xref ref-type="bibr" rid="hanspub.22169-ref4">4</xref>] 。</p></sec></sec><sec id="s5"><title>3. 全向移动平台的控制系统</title><p>为了整个系统的稳定性和实时性，通过搭建CAN总线网络，将主控和各个电机作为总线上的各个节点，进行数据的交换；对于远程遥控数据的传输采用DMA数据传输。</p><sec id="s5_1"><title>3.1. 软件设计思想与整体构架</title><p>本文研究的全方位移动平台采用半自动运行的方式。系统上电后，人通过肉眼视觉上的反馈，通过遥控器控制移动平台的运动状态。软件设计流程图如图4所示。</p><p>首先对系统的中断优先级以及系统变量进行初始化，遥控器通过DMA进行数据传输，主控对接收到完整的一帧数据进行解析。之后开启CAN通信中断，接收到电机反馈报文后触发中断服务函数CAN1_RX0_IRQHandler (void)，再利用PID控制算法计算出要赋予电机的电流值，再通过函数CAN_Send_Msg()将数据帧发送给相对应的电机，再关闭中断，完成一次循环。</p></sec><sec id="s5_2"><title>3.2. CAN总线实现</title><p>CAN总线的全称是Control Area Network，属于现场总线的范畴，它是一种有效支持分布式控制或实时控制的串行通信网络。最早是由德国BOSCH公司设计用来解决汽车通信问题。解决了简单的点对点式通信使得电控系统电气连接线长度和接头数增加的问题，同时还提升了电控系统的稳定性和可维护性 [<xref ref-type="bibr" rid="hanspub.22169-ref5">5</xref>] 。</p><p>主控STM32F407和电机电调都是CAN总线上的节点，之间通过数据帧进行通讯，通讯波特率设置为1 Mbps。为了对电机转速进行控制，我们将控制输出量填充到CAN数据帧相应的位，然后作为转矩命令发送给驱动板使其工作；同时驱动板以1 Khz的频率通过CAN总线反馈电机的运行状态。驱动板接收和反馈的数据帧格式如图5和图6所示。</p><p>从图5和图6看出驱动板反馈带有不同标识符的数据帧，主控接收到数据帧时产生中断。在中断服务函数中，利用反馈的机械角度，根据PID控制算法，将计算出的电流值填充到数据帧中，再通过CAN总线发送数据帧到电机驱动上，使之达到转速要求。硬件接线如图7所示。</p><p>图4. 软件流程图</p><p>图5. 驱动板接收报文格式图</p><p>图6. 驱动板反馈报文格式图</p><p>图7. CAN网络硬件连接图</p></sec><sec id="s5_3"><title>3.3. 遥控数据的DMA传输</title><p>遥控器的主要作用是控制全向移动平台的运动姿态，包含运动方向、速度以及运动轨迹的规划等。DR16接收机把遥控器发送的数据传输到STM32F407主控通过DMA传输。</p><p>DMA传输：全称是Direct Memory Access，直接通过存储器进行数据访问。该方法最大特点是无需CPU干预，也没有中断处理方式那样保留现场和恢复现场的过程，在硬件上搭建了一条RAM与I/O传输数据的快捷通道，很大程度减轻CPU的工作负载。CPU仅参与DMA初始化工作，而在整个数据传输过程中完全由DMA自身实现 [<xref ref-type="bibr" rid="hanspub.22169-ref6">6</xref>] 。STM32芯片DMA资源丰富，我们选择DMA1的数据流5，4号通道。外设基地址为串口寄存器“USART2- &gt; DR”，内存地址为自定义的数组Buffer[<xref ref-type="bibr" rid="hanspub.22169-ref"></xref>]。首先串口通过DMA控制器向主控发出DMA数据请求，主控响应DMA请求，把总线控制权交给DMA控制器，之后执行DMA数据传输，操作结束后DMA控制器把总线控制权交还给主控。数据从外设传输到内存中，每当遥控接收机向主控发送了一帧数据后，系统便触发中断，对遥控数据进行解析。</p></sec><sec id="s5_4"><title>3.4. PID控制算法</title><p>PID控制器即P (比例)，I (积分)，D (微分)控制。它是对给定值 r ( t ) 与实际输出值 y ( t ) 的偏差 e r r ( t ) 进行比例、积分、微分运算。它的数学表达式：</p><p>U ( t ) = K p ⋅ ( e r r ( t ) + 1 T I ⋅ ∫ 0 t e r r ( τ ) d τ + T D ⋅ d e r r ( t ) d t ) (9)</p><p>其离散形式为：</p><p>U ( k ) = K p ⋅ e r r ( k ) + K p ⋅ T T I ⋅ ∑ 1 k e r r ( j ) + K p ⋅ T d ⋅ ( e r r ( k ) − e r r ( k − 1 ) T )</p><p>式中Kp为比例系数；T<sub>i</sub>为积分时间常数；T<sub>d</sub>为微分时间常数； K i = K p ∗ T / T i ， K d = K p ∗ T d ；T是采样周期， e r r ( k ) 和 e r r ( k − 1 ) 分别是第k和第( k − 1 )时刻的偏差信号 [<xref ref-type="bibr" rid="hanspub.22169-ref7">7</xref>] 。位置式PID需要记录前面偏差的累计，还需计算最近两次偏差的差值。比例项，微分项，积分项采用试凑法确定具体数值。</p></sec></sec><sec id="s6"><title>4. 移动平台测试</title><p>根据上述计算，设计制作实验平台，在平台搭建的过程中，考虑到平台重量，对材料的选择进行了多次测试。最终选择铝合金和标准型材作为平台的主体材料，对于一些应力较小但是形状复杂的零部件采用3D打印。同时为了能够让电机转速快速达到设定转速，对PID控制算法的参数进行测试，当Kp = 2.0，Ki = 0.0，Kd = 0.35时能够满足要求。为了能够更好的达到远程操控的目的，选择了DT7 &amp; DR16遥控接收系统，经测试在40 m距离内操控平台，在复杂路况下对平台进行实地测试，操作过程流畅，平台的稳定性以及实时性均达到目标要求。实验平台如图8所示。</p></sec><sec id="s7"><title>5. 结束语</title><p>本文提出了一种基于CAN总线网络的全向移动平台的硬件和软件方案，通过远程遥控，在复杂环境下实现全方位的移动。主控采用STM32F407芯片，利用DMA进行数据的传输，保证了整个系统的稳定性和实时性。主控对遥控器发送的命令进行数据解析后，分配给四个电机不同的转速，从而控制平台的移动方向和速度。采用位置式PID控制算法，精确控制电机转速。实际应用中，对平台进行适当改造，便可以应用于仓储物流，探险救援，科研教学等领域。</p><p>图8. 全向移动测试平台</p></sec><sec id="s8"><title>致谢</title><p>本文获得2016国家级大学生创新创业训练计划资助(NO. 201610345026)。</p></sec><sec id="s9"><title>文章引用</title><p>彭思淇,田林晓,王 妍,廖 明,肖志兰,张克华. 基于STM32和CAN总线的全向移动平台控制系统设计Design of Omnidirectional Mobile Platform Control System Based on STM32 CAN Bus Control[J]. 计算机科学与应用, 2017, 07(09): 894-901. http://dx.doi.org/10.12677/CSA.2017.79102</p></sec><sec id="s10"><title>参考文献 (References)</title></sec></body><back><ref-list><title>References</title><ref id="hanspub.22169-ref1"><label>1</label><mixed-citation publication-type="other" xlink:type="simple">肖建. 移动机器人分布式控制系统的研究与实现[D]: [硕士学位论文]. 广州: 暨南大学出版社, 2015.</mixed-citation></ref><ref id="hanspub.22169-ref2"><label>2</label><mixed-citation publication-type="other" xlink:type="simple">田青. Mecanum轮式全向机器人位置精准控制的应用[D]: [硕士学位论文]. 南京: 东南大学出版社, 2015.</mixed-citation></ref><ref id="hanspub.22169-ref3"><label>3</label><mixed-citation publication-type="other" xlink:type="simple">王兴松. Mecanum轮全方位移动机器人技术及其应用[J]. 机械制造与自动化, 2014, 43(3): 1-6.</mixed-citation></ref><ref id="hanspub.22169-ref4"><label>4</label><mixed-citation publication-type="other" xlink:type="simple">陈博翁, 范传康, 贺骥. 基于麦克纳姆轮的全方位移动平台关键技术研究[J]. 东方电气评论, 2013, 27(108): 7-11.</mixed-citation></ref><ref id="hanspub.22169-ref5"><label>5</label><mixed-citation publication-type="other" xlink:type="simple">柴文峰, 丁学明. 基于STM32单片机CAN通信控制网络设计[J]. 电子科技, 2017, 30(3): 142-145.</mixed-citation></ref><ref id="hanspub.22169-ref6"><label>6</label><mixed-citation publication-type="other" xlink:type="simple">魏琳, 田波. 基于STM32F4系列的串口DMA数据处理传输研究[J]. 自动化应用, 2016(8): 92-93.</mixed-citation></ref><ref id="hanspub.22169-ref7"><label>7</label><mixed-citation publication-type="other" xlink:type="simple">王虎, 彭如恕, 尹泉. 基于STM32嵌入式模糊PID步进电机控制系统的设计[J]. 机械工程师, 2014(11): 139-140.</mixed-citation></ref></ref-list></back></article>