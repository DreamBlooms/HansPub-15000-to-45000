<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article  PUBLIC "-//NLM//DTD Journal Publishing DTD v3.0 20080202//EN" "http://dtd.nlm.nih.gov/publishing/3.0/journalpublishing3.dtd"><article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="3.0" xml:lang="en" article-type="research article"><front><journal-meta><journal-id journal-id-type="publisher-id">OJCS</journal-id><journal-title-group><journal-title>Open Journal of Circuits and Systems</journal-title></journal-title-group><issn pub-type="epub">2327-0853</issn><publisher><publisher-name>Scientific Research Publishing</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="doi">10.12677/OJCS.2017.63009</article-id><article-id pub-id-type="publisher-id">OJCS-21942</article-id><article-categories><subj-group subj-group-type="heading"><subject>OJCS20170300000_31877413.pdf</subject></subj-group><subj-group subj-group-type="Discipline-v2"><subject>信息通讯</subject><subject> 工程技术</subject></subj-group></article-categories><title-group><article-title>
 
 
  自行高炮双CAN总线采集系统设计与实现
  Design and Implementation of Dual CAN Bus Acquisition System for Self Propelled Antiaircraft Gun
 
</article-title></title-group><contrib-group><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>李</surname><given-names>大伟</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>周</surname><given-names>磊</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="corresp" rid="cor1"><sup>*</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>张</surname><given-names>福弟</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>万</surname><given-names>博</given-names></name><xref ref-type="aff" rid="aff2"><sup>2</sup></xref><xref ref-type="aff" rid="aff1"><sup>1</sup></xref></contrib></contrib-group><aff id="aff2"><addr-line>中国白城兵器试验中心，吉林 白城</addr-line></aff><aff id="aff1"><addr-line>null</addr-line></aff><author-notes><corresp id="cor1">* E-mail:<email>qq328848298@126.com(周磊)</email>;</corresp></author-notes><pub-date pub-type="epub"><day>05</day><month>09</month><year>2017</year></pub-date><volume>06</volume><issue>03</issue><fpage>71</fpage><lpage>80</lpage><permissions><copyright-statement>&#169; Copyright  2014 by authors and Scientific Research Publishing Inc. </copyright-statement><copyright-year>2014</copyright-year><license><license-p>This work is licensed under the Creative Commons Attribution International License (CC BY). http://creativecommons.org/licenses/by/4.0/</license-p></license></permissions><abstract><p>
 
 
   
   在某自行高炮作战试验鉴定过程中，针对需要实时记录车辆内部两路总线数据的问题，设计了一种基于双CAN总线的自动测试系统。该系统采用飞思卡尔MC9S12XEP100MAL单片机作为处理芯片，通过外接GPS授时芯片提高了数据测量精度，提出了主核与辅核XGATE数据共享方法以及双缓冲区周期交换策略，实现了双CAN口数据的不间断采集。应用表明，该系统能够适用于该自行高炮武器系统总线数据的实时采集、存储及传输任务，解决了作战试验鉴定过程中数据采集的问题。&lt;br/&gt;Test system based on dual CAN bus is designed in order to solve the problem of real-time recording of two bus data in the vehicle during the battle test of a self propelled antiaircraft gun. The system uses Freescale Carle MC9S12XEP100MAL chip as the processing chip, and improves the data measurement accuracy through the external GPS timing chip. The method of data sharing between main core and auxiliary kernel XGATE and double buffer cycle switching strategy are proposed, and the uninterrupted data acquisition of double CAN port is realized. The application shows that the system can be applied to the real-time acquisition, storage and transmission of the bus data of the self-propelled antiaircraft gun weapon system. It is easy to use and solves the problem of data acquisition in the process of operational test identification. 
  
 
</p></abstract><kwd-group><kwd>车辆状态监测，CAN总线，数据采集，作战试验, Vehicle Condition Monitoring</kwd><kwd> CAN Bus</kwd><kwd> Data Acquisition</kwd><kwd> Operation Test</kwd></kwd-group></article-meta></front><body><sec id="s1"><title>自行高炮双CAN总线采集系统设计与实现<sup> </sup></title><p>李大伟，周磊，张福弟，万博</p><p>中国白城兵器试验中心，吉林 白城</p><p>收稿日期：2017年8月14日；录用日期：2017年8月28日；发布日期：2017年9月5日</p><disp-formula id="hanspub.21942-formula6"><graphic xlink:href="http://html.hanspub.org/file/1-2780098x5_hanspub.png"  xlink:type="simple"/></disp-formula></sec><sec id="s2"><title>摘 要</title><p>在某自行高炮作战试验鉴定过程中，针对需要实时记录车辆内部两路总线数据的问题，设计了一种基于双CAN总线的自动测试系统。该系统采用飞思卡尔MC9S12XEP100MAL单片机作为处理芯片，通过外接GPS授时芯片提高了数据测量精度，提出了主核与辅核XGATE数据共享方法以及双缓冲区周期交换策略，实现了双CAN口数据的不间断采集。应用表明，该系统能够适用于该自行高炮武器系统总线数据的实时采集、存储及传输任务，解决了作战试验鉴定过程中数据采集的问题。</p><p>关键词 :车辆状态监测，CAN总线，数据采集，作战试验</p><disp-formula id="hanspub.21942-formula7"><graphic xlink:href="http://html.hanspub.org/file/1-2780098x6_hanspub.png"  xlink:type="simple"/></disp-formula><p>Copyright &#169; 2017 by authors and Hans Publishers Inc.</p><p>This work is licensed under the Creative Commons Attribution International License (CC BY).</p><p>http://creativecommons.org/licenses/by/4.0/</p><p><img src="http://image.hanspub.org:8080\Html/htmlimages\1-2890033x\e70a10f1-7c93-45ea-9603-062237856e4b.png" /><img src="http://image.hanspub.org:8080\Html\htmlimages\1-2890033x\e898c85e-ffc4-45c9-b817-14224a4d6960.png" /></p></sec><sec id="s3"><title>1. 引言</title><p>随着装备作战试验任务在我军陆续开展，针对作战单元信息采集相关技术研究日益紧迫。目前，车载类武器平台作为最小作战本体，需要在真实的作战环境下对其使用过程中的车电、火控等参数进行精确测量并实时传输。基于此，本文以某自行高炮武器系统作为研究对象，重点分析了其总线结构和协议，设计并开发了双CAN总线状态参数采集系统，为装备的作战效能、作战适应性和生存性，以及体系贡献率评估提供精确的测试数据支撑。</p></sec><sec id="s4"><title>2. 系统总体及硬件设计</title><sec id="s4_1"><title>2.1. 系统总体设计</title><p>系统主要由车载采集终端和数据处理服务器组成。所有的采集终端由统一的时统进行控制。各终端通过专用的试验通讯网络将数据汇总到上位机的数据处理服务器中。为确保采集终端能够满足耐低温、三防等军用标准，设计采用飞思卡尔MC9S12XEP100MAL单片机作为核心处理器。该芯片内部集成PLL电路同时具有倍频功能，通过外部加装4 M晶振，能够倍频到48 M，满足电磁兼容要求 [<xref ref-type="bibr" rid="hanspub.21942-ref1">1</xref>] 。电路外围搭配W5100芯片实现数据的透明传输，其功能是接收两路CAN总线数据并将数据封装到一个数据包中，在采集卡上以TXT文件的形式存储在板载SD卡中，同时将该数据包以UDP协议的方式通过网口发送给数据采集服务器。同时系统还应具备总线数据接收状态指示、电源状态指示、断电数据保护、关键通信参数在线编程、数据筛选等功能，如图1所示。</p><p>在系统工作的时候，先对总线差分信号进行处理，将双端输入的差分信号通过总线驱动器或差分接收器转换成单端口的高低电平信号，然后送到单片机的CAN总线接口，由协处理器XGATE以中断方式进行接收，一个通信周期(80 ms)相关数据采集完毕后进行封装，在周期定时器中断控制下，由主控制器HC12X通过SPI总线接口存储到板载SD卡中，同时通过并行总线利用W5100芯片转换成UDP数据，发往数据处理服务器 [<xref ref-type="bibr" rid="hanspub.21942-ref2">2</xref>] 。利用4个LED灯指示采集卡工作状态，使用4个拨码开关选择系统的工作方式等。</p></sec><sec id="s4_2"><title>2.2. 单片机外围电路设计</title><p>该部分电路主要包括程序下载电路、时钟电路、单片机输入电源滤波、工作状态指示电路以及最小系统所需的外围电路。时钟电路采用4 MHz晶振，电源滤波电路，外部输入电源采用100 UH电感、10 UF</p><p>图1. 系统原理框图</p><p>钽电容、103陶瓷电容、104陶瓷电容共同构成LC滤波电路，内部电源采用102陶瓷电容和220 NF陶瓷电容滤波 [<xref ref-type="bibr" rid="hanspub.21942-ref3">3</xref>] 。工作状态指示电路共有四个LED指示灯。PORTE5、PORTE6以及PORTE7通过3.3 K电阻下拉到地。单片机核心电路如图2所示。</p></sec><sec id="s4_3"><title>2.3. 电源电路设计</title><p>目前通用轮式车辆底盘都提供DC12V接口用于车载设备供电，因此本系统电源采用直接从车内取电的方式工作。为确保设备在密闭空间内能够稳定工作，系统选择开关电源代替传统的LDO电源芯片，将终端电源转换效率提高到95%以上 [<xref ref-type="bibr" rid="hanspub.21942-ref4">4</xref>] [<xref ref-type="bibr" rid="hanspub.21942-ref5">5</xref>] 。终端内部设计两个供电电路，首先采用N7805模块将DC12V转换为DC5V，用于给单片机及CAN收发芯片等核心电路供电；之后采用N7803模块将DC12V转换为DC3V，给网络芯片和SD卡供电。由于开关电源芯片存在纹波大的缺点，本系统在芯片后端增加多级滤波电容，能够将纹波控制到20 mV以内。同时DC12V电路处设计电源开关，DC5V、DC3V输出分别放置500 MA和300 MA可恢复保险做过流保护，放置两个LED灯指示电源状态。如图3所示。</p></sec><sec id="s4_4"><title>2.4. CAN总线接口电路设计</title><p>CAN总线节点采用MC9S12XEP100单片机做控制器，其集成有6个CAN总线接口，CAN总线收发器采用AD公司的ADM3053芯片，其内部集成了隔离DC/DC电源，是一种自隔离的CAN总线收发器 [<xref ref-type="bibr" rid="hanspub.21942-ref6">6</xref>] 。节点电路设计有EMI滤波电路以及ESD静电保护电路，其节点硬件电路如图4所示。</p></sec></sec><sec id="s5"><title>3. 系统软件设计</title><sec id="s5_1"><title>3.1. 程序流程设计</title><p>整个程序主要分为两种模式，一种参数设置模式，一种正常工作模式，两种模式通过拨码开关进行选择。参数设置模式主要用于板卡的网络参数以及数据采集服务器网络参数设置。正常工作模式主要用于正常CAN总线数据采集。程序主程序流程如图5所示。</p><p>图2. 单片机核心电路原理图</p></sec><sec id="s5_2"><title>3.2. 中断分配</title><p>为确保系统能够及时响应接收到的数据，整个程序设计了4个中断。同时为确保中断通道不会互相干扰，对不同中断分配相应的优先级。一个80 MS的周期定时中断，分配给主核处理；两个CAN接口中断、一个SCI串口中断，分配给XGATE处理。中断流程如图6所示。</p></sec></sec><sec id="s6"><title>4. 双缓冲区周期交换法</title><sec id="s6_1"><title>4.1. 主核与辅核XGATE数据共享</title><p>系统辅核XGATE负责处理接收数据中断，采集CAN总线数据、时间信息且完成数据装帧。主核负</p><p>图3. 电源电路原理图</p><p>图4. CAN接口电路原理图</p><p>图5. 系统主程序流程图</p><p>责将采集到的数据按80 ms的周期保存数据以及将数据发送给上位机服务器。因此，必须保证数据和各种标志要在主核与辅核XGATE之间实时可靠共享。本系统通过设计双缓冲区标志位的方法，通过周期判断缓冲区使用状态，以保证主辅核直接操作两个缓冲区数据，算法流程如图7所示。</p></sec><sec id="s6_2"><title>4.2. 数据采集策略</title><p>本系统包括两个CAN总线接口，能够同时接收数据，通过双缓冲区周期交换法实现双CAN口的不间断采集，当单片机的辅核XGATE通过CAN口接收到有效数据帧，经解码处理后，依照数据帧的先后顺序存入BUFF1中，此时主核HC12X对存储在BUFF2中的数据进行处理，80 ms后，再收到CAN数据依次存入BUFF2中，此时主核HC12X对存储在BUFF1中的数据进行处理，再过80 ms再存到BUFF1中，如此循环，这样使得使用的缓冲区以80 ms为周期，进行交换使用，如图8所示，图中深色的表示CAN口2接收到的数据，浅色的表示CAN口1接收到的数据。在每个缓冲区的第8个字节到第44个字节用于存放时间，每个通信周期填充一次。</p><p>为便于存储，需将接收到的数据转换成ASCII码，因此，为保证CAN口中断处理函数的响应速度，减少中断服务程序消耗的总线时钟数，系统采用转换查表的方式进行，即先计算好十六进制数对应的ASCII码，制作一个二维数组，其数组索引号即为16进制数，数组的元素就是其对应的ASCII码，这样就将一个16进制数变为两个字符。之后采用位左移操作代替乘法操作，用位右移操作代替除法操作，减少时钟周期消耗，提高效率。比如计算CAN扩展帧ID，如图9所示。</p><p>图6. SCI3中断服务程序流程图</p></sec></sec><sec id="s7"><title>5. 实验结果及分析</title><p>将系统两路CAN接收端接入被试装备预留监测接口，通过调整装备火控计算机总线数据，对系统性能进行测试。验证结果表明，当边采集边存储时，极限速度为每秒3000帧左右，如不需存储，采集速度可达每秒5000帧。将SD卡中保存的数据与总线发送数据进行比对，结果完全一致。终端板卡如图10所示。</p><p>在数据记录的同时，采集到的数据通过网口发送给中心上位机数据，数据处理服务器通过IP抓包工具进行抓包，将数据进行解码处理，解码结果与CAN总线数据一致。且源IP地址、源端口号、目的IP地址、目的端口号、网关IP地址均正确无误。采集卡的采集、转发、存储功能均正常，且长时间工作稳定。</p><p>图7. 主辅核数据共享算法</p><p>图8. BUFF1, BUFF2轮流存储</p><p>图9. 计算CAN扩展帧ID</p><p>图10. 实物图</p></sec><sec id="s8"><title>6. 结束语</title><p>本文以某自行高炮武器系统装备作战试验鉴定过程中总线数据采集作为研究对象，针对该武器系统双CAN总线的特点以及对采集设备高机动、高实时性的测试需求，开发了基于双总线的武器状态参数采集系统，利用装备自带总线及各分部件预留监测接口，设计了主核与辅核XGATE数据共享方法以及双缓冲区周期交换策略，完成了双CAN口数据的不间断采集。实际试验表明，该系统能够实现了火控系统工作时各类控制信息、工作状态信息及装药参数等数据的快速实时采集和传输，为装备作战试验鉴定提供了可靠的试验数据。</p></sec><sec id="s9"><title>文章引用</title><p>李大伟,周 磊,张福弟,万 博. 自行高炮双CAN总线采集系统设计与实现Design and Implementation of Dual CAN Bus Acquisition System for Self Propelled Antiaircraft Gun[J]. 电路与系统, 2017, 06(03): 71-80. http://dx.doi.org/10.12677/OJCS.2017.63009</p></sec><sec id="s10"><title>参考文献 (References)</title></sec></body><back><ref-list><title>References</title><ref id="hanspub.21942-ref1"><label>1</label><mixed-citation publication-type="other" xlink:type="simple">Mothony, H.-J., Kaiser, K.-H. and Unruh, J. (1992) Network Architecture for CAN. SAE Transactions, Section 6, Article ID: 93004.</mixed-citation></ref><ref id="hanspub.21942-ref2"><label>2</label><mixed-citation publication-type="other" xlink:type="simple">饶运涛. 现场总线CAN原理与应用技术[M]. 北京: 北京航空航天大学出版社, 2003.</mixed-citation></ref><ref id="hanspub.21942-ref3"><label>3</label><mixed-citation publication-type="other" xlink:type="simple">梁宇恒. 高精度数据采集及DSP+FPGA高速信号处理硬件系统设计[D]: [硕士学位论文]. 西安: 电子科技大学, 2012.</mixed-citation></ref><ref id="hanspub.21942-ref4"><label>4</label><mixed-citation publication-type="other" xlink:type="simple">杨云飞. 基于CAN总线的某型数字化战车自动测试系统设计[J]. 计算机测量与控制, 2015, 23(1): 127-131.</mixed-citation></ref><ref id="hanspub.21942-ref5"><label>5</label><mixed-citation publication-type="other" xlink:type="simple">中国飞利浦单片机应用协会资料信息部. CAN技术规范及器件[Z].</mixed-citation></ref><ref id="hanspub.21942-ref6"><label>6</label><mixed-citation publication-type="other" xlink:type="simple">王晓飞, 凌海风, 肖兴青, 等. 装备使用保障寿命周期档案管理与应用[J]. 四川兵工学报, 2011, 32(2): 16-18.</mixed-citation></ref></ref-list></back></article>