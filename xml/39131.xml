<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article  PUBLIC "-//NLM//DTD Journal Publishing DTD v3.0 20080202//EN" "http://dtd.nlm.nih.gov/publishing/3.0/journalpublishing3.dtd"><article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="3.0" xml:lang="en" article-type="research article"><front><journal-meta><journal-id journal-id-type="publisher-id">SEA</journal-id><journal-title-group><journal-title>Software Engineering and Applications</journal-title></journal-title-group><issn pub-type="epub">2325-2286</issn><publisher><publisher-name>Scientific Research Publishing</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="doi">10.12677/SEA.2020.96052</article-id><article-id pub-id-type="publisher-id">SEA-39131</article-id><article-categories><subj-group subj-group-type="heading"><subject>SEA20200600000_36353682.pdf</subject></subj-group><subj-group subj-group-type="Discipline-v2"><subject>工程技术</subject></subj-group></article-categories><title-group><article-title>
 
 
  基于stm32的RDM灯具控制系统
  RDM Lamp Control System Based on stm32
 
</article-title></title-group><contrib-group><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>钱</surname><given-names>雨</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="corresp" rid="cor1"><sup>*</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>张</surname><given-names>传武</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>范</surname><given-names>旭杰</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref></contrib></contrib-group><aff id="aff1"><addr-line>西南民族大学电子信息学院，四川 成都</addr-line></aff><aff id="aff2"><addr-line>null</addr-line></aff><pub-date pub-type="epub"><day>14</day><month>12</month><year>2020</year></pub-date><volume>09</volume><issue>06</issue><fpage>447</fpage><lpage>455</lpage><permissions><copyright-statement>&#169; Copyright  2014 by authors and Scientific Research Publishing Inc. </copyright-statement><copyright-year>2014</copyright-year><license><license-p>This work is licensed under the Creative Commons Attribution International License (CC BY). http://creativecommons.org/licenses/by/4.0/</license-p></license></permissions><abstract><p>
 
 
  在舞台美术中，光和色的组合是表现人物内心的重要因素；通过调整光比、设计用色可以创造舞台的空间感、时间感等客观因素和人物内心的主观表现。调整光比即控制舞台灯具设备的传统方法是采用单向控制的设备控制协议Digital Multiple X 512，而作为DMX协议增强的Remote Device Management协议采用双向通信，具有更为强大的功能。本文在STM32硬件系统基础上，搭载实时操作系统freertos，完成了基于RDM协议的舞台灯具控制系统，扩展了传统舞台灯具控制系统的功能。
   In stage art, the combination of light and color is the important factors that express the inward world of the characters. By adjusting the light ratio and designing the color, we can create the ob-jective factors such as the sense of space and time of the stage and the subjective performance of the characters’ heart. The traditional way to adjust the light ratio, that is, to control the stage lighting equipment, is to use the device control protocol DMX512, which is one-way control, while the RDM protocol, which is enhanced by the DMX512 protocol, adopts two-way communication, which has more powerful functions. Based on STM32 hardware system and FreeRTOS, the stage lamp control system based on RDM protocol is completed, which extends the function of traditional stage lamp control system.
 
</p></abstract><kwd-group><kwd>舞台，色彩，心理，灯具，控制, Stage</kwd><kwd> Color</kwd><kwd> Psychology</kwd><kwd> Lamps</kwd><kwd> Control</kwd></kwd-group></article-meta></front><body><sec id="s1"><title>摘要</title><p>在舞台美术中，光和色的组合是表现人物内心的重要因素；通过调整光比、设计用色可以创造舞台的空间感、时间感等客观因素和人物内心的主观表现。调整光比即控制舞台灯具设备的传统方法是采用单向控制的设备控制协议Digital Multiple X 512，而作为DMX协议增强的Remote Device Management协议采用双向通信，具有更为强大的功能。本文在STM32硬件系统基础上，搭载实时操作系统freertos，完成了基于RDM协议的舞台灯具控制系统，扩展了传统舞台灯具控制系统的功能。</p></sec><sec id="s2"><title>关键词</title><p>舞台，色彩，心理，灯具，控制</p></sec><sec id="s3"><title>RDM Lamp Control System Based on stm32</title><p>Yu Qian, Chuanwu Zhang, Xujie Fan</p><p>School of Electronic Information, Southwest Minzu University, Chengdu Sichuan</p><p><img src="//html.hanspub.org/file/1-2690479x4_hanspub.png" /></p><p>Received: Nov. 22<sup>nd</sup>, 2020; accepted: Dec. 7<sup>th</sup>, 2020; published: Dec. 14<sup>th</sup>, 2020</p><p><img src="//html.hanspub.org/file/1-2690479x5_hanspub.png" /></p></sec><sec id="s4"><title>ABSTRACT</title><p>In stage art, the combination of light and color is the important factors that express the inward world of the characters. By adjusting the light ratio and designing the color, we can create the objective factors such as the sense of space and time of the stage and the subjective performance of the characters’ heart. The traditional way to adjust the light ratio, that is, to control the stage lighting equipment, is to use the device control protocol DMX512, which is one-way control, while the RDM protocol, which is enhanced by the DMX512 protocol, adopts two-way communication, which has more powerful functions. Based on STM32 hardware system and FreeRTOS, the stage lamp control system based on RDM protocol is completed, which extends the function of traditional stage lamp control system.</p><p>Keywords:Stage, Color, Psychology, Lamps, Control</p><disp-formula id="hanspub.39131-formula3"><graphic xlink:href="//html.hanspub.org/file/1-2690479x6_hanspub.png"  xlink:type="simple"/></disp-formula><p>Copyright &#169; 2020 by author(s) and Hans Publishers Inc.</p><p>This work is licensed under the Creative Commons Attribution International License (CC BY 4.0).</p><p>http://creativecommons.org/licenses/by/4.0/</p><p><img src="//html.hanspub.org/file/1-2690479x7_hanspub.png" /> <img src="//html.hanspub.org/file/1-2690479x8_hanspub.png" /></p></sec><sec id="s5"><title>1. 引言</title><p>在舞台美术中，灯光艺术作为传递视觉效果重要手段之一 [<xref ref-type="bibr" rid="hanspub.39131-ref1">1</xref>]，舞台上灯光的各种状态，变化以及色彩颜色触动或引起观众的心理种种变化，是因为色彩的感观效果非常直接，而又能有力地表现情感 [<xref ref-type="bibr" rid="hanspub.39131-ref2">2</xref>]。有色光颜色的选择，灯光设计者遵循人类对客观世界的主观感受习惯，通过调整光比，设计用色来创造舞台的空间感、时间感等客观因素和人物内心的主观表现 [<xref ref-type="bibr" rid="hanspub.39131-ref1">1</xref>]。</p><p>调整光比即控制舞台灯具设备，目前在舞台控制中DMX512控制协议使用最普遍，物理层采用RS-485设计 [<xref ref-type="bibr" rid="hanspub.39131-ref3">3</xref>]，但DMX512有单向传输，无法获得灯具状态、信息和无法配置设备等缺点，美国战区技术研究所(USITT)提出的RDM协议是对DMX512协议的增强，RDM协议允许对舞台设备进行配置、状态监视和管理 [<xref ref-type="bibr" rid="hanspub.39131-ref3">3</xref>]。为了更好控制舞台，方便舞台设计，本文设计了基于stm32和实时操作系统freertos的RDM灯具控制系统。</p></sec><sec id="s6"><title>2. 原理综诉</title><sec id="s6_1"><title>2.1. 色彩心理学</title><p>据心理学研究，光色与人们的情绪有关，光的波长不同、颜色的感觉也不同。光进入眼帘后产生的感觉，这种感觉进一步被大脑判断，开始感到颜色就是心理现象 [<xref ref-type="bibr" rid="hanspub.39131-ref2">2</xref>]。</p><p>暖色与冷色是依据心理错觉对色彩的物理性分类 [<xref ref-type="bibr" rid="hanspub.39131-ref1">1</xref>]，亮色颜色更容易和积极情绪联系，而暗色容易跟消极颜色联系 [<xref ref-type="bibr" rid="hanspub.39131-ref4">4</xref>]。红色的视觉穿透力最强，让人感到兴奋、炎热、活泼、热情、充实、饱满, 有种挑战的意味 [<xref ref-type="bibr" rid="hanspub.39131-ref5">5</xref>]；黄色是亮度最高的颜色，它具有警告的效果，又象征着财富、权利、智慧、辉煌等；黑色象征着高雅、权威，黑色意味着空无，像太阳的毁灭，像永恒的沉默，没有未进展，而与之对立的白色象征着纯洁与神圣等。色彩心理学不仅能更好的服务于舞台灯光，而色彩心理学本身有着很大的发展空间，非常值得去深入发掘，横向的运用于舞台美术的各个专业 [<xref ref-type="bibr" rid="hanspub.39131-ref1">1</xref>]。</p></sec><sec id="s6_2"><title>2.2. DMX、RDM协议</title><p>RDM是远程设备管理协议，以DMX512-A为基础 [<xref ref-type="bibr" rid="hanspub.39131-ref6">6</xref>]。一次完整波形如图1所示。</p><p>图1. Dmx-rdm数据包波形</p><p>RDM与DMX传输主要区别有表1：</p><table-wrap id="table1" ><label><xref ref-type="table" rid="table1">Table 1</xref></label><caption><title> Dmx-rdm data difference</title></caption><table><tbody><thead><tr><th align="center" valign="middle" >协议</th><th align="center" valign="middle" >DMX</th><th align="center" valign="middle" >RDM</th></tr></thead><tr><td align="center" valign="middle" >传输方向</td><td align="center" valign="middle" >单向</td><td align="center" valign="middle" >双向</td></tr><tr><td align="center" valign="middle" >Break时间</td><td align="center" valign="middle" >88~352 us</td><td align="center" valign="middle" >176~352 us</td></tr><tr><td align="center" valign="middle" >数据槽0值(起始码)</td><td align="center" valign="middle" >0&#215; 00</td><td align="center" valign="middle" >0 &#215; CC</td></tr><tr><td align="center" valign="middle" >数据长度</td><td align="center" valign="middle" >不定长，最长257字节</td><td align="center" valign="middle" >定长，513字节</td></tr></tbody></table></table-wrap><p>表1. Dmx-rdm数据区别</p><p>除了表1中的主要区别外，RDM设备回应上位机指令时有两中数据包格式，RDM控制命令定义为三类：设备查找、设备信息收集、设备设置命令类，其中回应设备查找命令时数据包不需要发送break信号，多设备回应时break信号会使所有数据无效，而其他命令只会有指定id的设备回应。</p></sec></sec><sec id="s7"><title>3. 系统设计</title><sec id="s7_1"><title>3.1. 硬件设计</title><p>如图2所示，主控板使用STM32F103VCT6为核心，共有电源模块、485模块、OLED显示屏、按键模块、升压模块和温度模块组成。主控板由12 V电源进行供电，电源模块将12 V进行5 V、3.3 V等供电适配；手动状态时用户操作按键进行控制，相应操作结果反馈在显示屏上；DMX-RDM控制时，485模块将485电平转换，便于串口通信；由于主控板输出PWM波控制灯、风扇时电压可能不够，需要通过升压模块进行适配。</p><p>图2. 系统框图</p></sec><sec id="s7_2"><title>3.2. 软件设计</title><p>系统软件是基于实时操作系统freertos完成的，整个系统由开始任务、RDM任务、485管理任务、485中断任务、OLED显示任务、PWM控制任务等组成。开始任务会将其他任务全数创建，并将自己删除以节省系统资源，系统会进行任务调度执行其他任务。如图3所示为主函数流程图。</p><sec id="s7_2_1"><title>3.2.1. RDM任务程序设计</title><p>图4所示为RDM任务流程图，RDM任务是RDM的数据校验、分析任务，RDM任务首先初始化错误等标志、数据长度参数和申请缓存空间，然后初始化RDM驱动函数，并负责阻塞等待485中断函数将数据放入消息队列中，然后解析RDM数据。RDM数据验证子程序是用于判断接收到的RDM不定长数据符合校验和，校验和正确后判断是否指定目标UID符合回应条件；验证成功后RDM解析子程序将会进行数据解析并进行相应的处理后回应。</p><p>图3. 主函数流程图</p><p>图4. RDM任务流程图</p></sec><sec id="s7_2_2"><title>3.2.2. 485管理任务程序设计</title><p>图5所示为485管理任务流程图，DMX、RDM驱动函数初始化完成后，485管理任务才能进行创建运行，485管理任务首先初始化通知值、485开关等标志参数后初始化485驱动，485中断函数开启，之后阻塞接收任务通知，所有跟RDM、485相关的任务通知都会集中在这个任务中处理。</p><p>图5. 485管理任务流程图</p></sec><sec id="s7_2_3"><title>3.2.3. 中断程序设计</title><p>图6所示为中断流程图，485中断函数是使用串口中断，接收DMX和RDM时由于需要捕获break信号，串口使用lin模式可以捕获前导break信号，虽不能确定break时间，但可以减少硬件资源和系统定时器资源，还可以用数据包的首数据槽即起始码来区别DMX与RDM的信号。</p><p>每个设备默认需要的DMX槽数都是固定的，DMX起始地址会在之前预先配置好，DMX数据固定为513长度，可直接判断从DMX起始地址开始接收固定槽数的数据，并通过DMX消息队列发送给PWM任务进行控制；而RDM是不定长的数据，在RDM通信时总会有一段空闲时间，可以通过串口的空闲中断来判断RDM已经传送完成，在将接收完成的RDM数据通过RDM消息队列发送给RDM任务进行解析回应。</p><p>图6. 中断流程图</p></sec></sec><sec id="s7_3"><title>3.3. 系统联调</title><p>图7为控制板实物图，四个按键可以直接手动控制灯具所有通道的数值，并能设置地址值，OLED屏幕可以显示所有操作、温度，同时如果有DMX、RDM信号也能在界面上显示，图7中右部分为连接测试图，测试时使用DMX-RDM测试平台软件发送命令，使用keil和stlink进行主控板仿真。</p><p>图7. 实物图</p><p>图8、图9为与DMX协议相关的测试图，图8中测试平台发送DMX数据，数据槽0是起始码0，主控板设置地址为1，固定接收8个槽数据，图9中dmx_buf从dmx数据队列中成功接受到8个数据，与测试平台发送DMX数据包中1-8槽数据相同。</p><p>图8. DMX协议测试图</p><p>图9. DMX任务测试图</p><p>图10~13为RDM相关的测试图，图10中测试平台执行查找程序，在二分查找的过程中接收到主控板的回应数据，最后成功解析数据，获得主控板id。图11为RDM任务接收数据，rdm_buf在RDM数据队列中获取数据后，经过校验后输入解析RDM子程序。图12为查找命令回应数据，在图中回应数据与测试平台接收的数据一致，图13为RDM其他命令回应数据，头数据为0xCC，与测试平台接受到数据格式是一致的。从所有的测试看，本系统能够可靠接收DMX、RDM信号，并能正确解析并执行命令，达到了预期效果。</p><p>图10. RDM协议测试图</p><p>图11. RDM任务测试图</p><p>图12. RDM查找命令回应图</p><p>图13. RDM其他命令回应图</p></sec></sec><sec id="s8"><title>4. 结束语</title><p>本文给出一个支持RDM协议的舞台灯具控制系统的开发过程及其技术实现，扩展了传统舞台灯具控制系统的功能。系统开发时出现了不少问题，一是freertos移植开发，在freertos移植过程中的一些参数修改和配置，还有在freertos开发时任务、队列、中断等的配合使用；二是DMX-RDM协议中都会有前导break信号，它们的时间是无法确定且范围有交集，RDM协议通信时是不定长的；三是RDM驱动中采集、设置命令与各个模块的配合等。支持RDM功能舞台设备能让舞台设计时控制更加方便，为远程控制舞台提供了基础，本系统还存在不足的地方，但相信在未来开发中会得到完善和改进。</p></sec><sec id="s9"><title>基金项目</title><p>四川省科技厅应用基础项目资助(2018JY0338)，西南民族大学中央高校基本科研业务费电子信息工程专项资助(2020PTJS19101)。</p></sec><sec id="s10"><title>文章引用</title><p>钱 雨,张传武,范旭杰. 基于stm32的RDM灯具控制系统RDM Lamp Control System Based on stm32[J]. 软件工程与应用, 2020, 09(06): 447-455. https://doi.org/10.12677/SEA.2020.96052</p></sec><sec id="s11"><title>参考文献</title></sec></body><back><ref-list><title>References</title><ref id="hanspub.39131-ref1"><label>1</label><mixed-citation publication-type="other" xlink:type="simple">王晨. 色彩心理学对舞台灯光的影响[J]. 剧影月报, 2015(2): 71-72.</mixed-citation></ref><ref id="hanspub.39131-ref2"><label>2</label><mixed-citation publication-type="other" xlink:type="simple">刘海. 试论舞台灯光与观众的心理反应[J]. 大众文艺, 2011(17): 248-249.</mixed-citation></ref><ref id="hanspub.39131-ref3"><label>3</label><mixed-citation publication-type="other" xlink:type="simple">李峰. 基于DMX景观照明系统的RDM技术设计与应用[D]: [硕士学位论文]. 沈阳: 沈阳建筑大学, 2019.</mixed-citation></ref><ref id="hanspub.39131-ref4"><label>4</label><mixed-citation publication-type="other" xlink:type="simple">张聪聪. 音乐和颜色的情绪性关联[D]: [硕士学位论文]. 上海: 华东师范大学, 2014.</mixed-citation></ref><ref id="hanspub.39131-ref5"><label>5</label><mixed-citation publication-type="other" xlink:type="simple">何睿. 谈色彩对人类心理情绪的影响[J]. 美术大观, 2009(1): 72-73.</mixed-citation></ref><ref id="hanspub.39131-ref6"><label>6</label><mixed-citation publication-type="other" xlink:type="simple">马愉兴. RDM协议详解及其实现[J]. 电子技术与软件工程, 2018(14): 99-103.</mixed-citation></ref></ref-list></back></article>