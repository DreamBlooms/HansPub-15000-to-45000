<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article  PUBLIC "-//NLM//DTD Journal Publishing DTD v3.0 20080202//EN" "http://dtd.nlm.nih.gov/publishing/3.0/journalpublishing3.dtd"><article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="3.0" xml:lang="en" article-type="research article"><front><journal-meta><journal-id journal-id-type="publisher-id">IaE</journal-id><journal-title-group><journal-title>Instrumentation and Equipments</journal-title></journal-title-group><issn pub-type="epub">2332-6980</issn><publisher><publisher-name>Scientific Research Publishing</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="doi">10.12677/IaE.2019.71003</article-id><article-id pub-id-type="publisher-id">IaE-28911</article-id><article-categories><subj-group subj-group-type="heading"><subject>IaE20190100000_14631545.pdf</subject></subj-group><subj-group subj-group-type="Discipline-v2"><subject>工程技术</subject></subj-group></article-categories><title-group><article-title>
 
 
  智能快速充电设备的CAN总线通讯设计
  Communication Design Based on CAN Bus for Quick Smart Charger
 
</article-title></title-group><contrib-group><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>程</surname><given-names>宇</given-names></name><xref ref-type="aff" rid="aff1"><sup>1</sup></xref><xref ref-type="corresp" rid="cor1"><sup>*</sup></xref></contrib><contrib contrib-type="author" xlink:type="simple"><name name-style="western"><surname>陈</surname><given-names>世杰</given-names></name><xref ref-type="aff" rid="aff3"><sup>3</sup></xref><xref ref-type="aff" rid="aff2"><sup>2</sup></xref></contrib></contrib-group><aff id="aff3"><addr-line>上海翌工电子科技有限公司，上海</addr-line></aff><aff id="aff1"><addr-line>上海交通大学、电子信息与电气工程学院，上海</addr-line></aff><aff id="aff2"><addr-line>null</addr-line></aff><pub-date pub-type="epub"><day>24</day><month>01</month><year>2019</year></pub-date><volume>07</volume><issue>01</issue><fpage>15</fpage><lpage>22</lpage><permissions><copyright-statement>&#169; Copyright  2014 by authors and Scientific Research Publishing Inc. </copyright-statement><copyright-year>2014</copyright-year><license><license-p>This work is licensed under the Creative Commons Attribution International License (CC BY). http://creativecommons.org/licenses/by/4.0/</license-p></license></permissions><abstract><p>
 
 
   为了满足快速充电市场对充电设备的实时状态监控，在大电流充电器的基础上，研究了加入CAN总线接口的通讯工作。利用CAN总线传输距离远，抗干扰能力强，易于扩展的特点，将充电器数据实时传送到上位机设备，上位机对充电器的电压和电流实时调整，实现充电最优化。详细分析了CAN总线工作原理和通讯协议的建立，最后通过搭建一个实验样机，验证了理论分析的正确性和可行性。 In order to meet the real-time status monitoring of chargers in the fast charging market, on the basis of high-current chargers, we add the CAN bus interface to communicate. With the character-istics of long distance transmission, strong anti-interference ability and easy expansion, we transmit the charger data to the upper computer equipment in real time. The upper computer adjusts the voltage and current of chargers in real time to achieve the best charging. The working principle of CAN-bus and the establishment of communication protocol are analyzed in detail. Finally, an experimental prototype is built to verify the correctness and practicability of the theoretical analysis. 
 
</p></abstract><kwd-group><kwd>充电设备，CAN总线，通讯协议，上位机, Charging Equipment</kwd><kwd> CAN Bus</kwd><kwd> Communication Protocol</kwd><kwd> Host Computer</kwd></kwd-group></article-meta></front><body><sec id="s1"><title>智能快速充电设备的CAN总线通讯设计<sup> </sup></title><p>程宇<sup>1</sup>，陈世杰<sup>2</sup></p><p><sup>1</sup>上海交通大学、电子信息与电气工程学院，上海</p><p><sup>2</sup>上海翌工电子科技有限公司，上海</p><p><img src="//html.hanspub.org/file/3-2990224x1_hanspub.png" /></p><p>收稿日期：2019年1月22日；录用日期：2019年2月11日；发布日期：2019年2月19日</p><disp-formula id="hanspub.28911-formula17"><graphic xlink:href="//html.hanspub.org/file/3-2990224x5_hanspub.png"  xlink:type="simple"/></disp-formula></sec><sec id="s2"><title>摘 要</title><p>为了满足快速充电市场对充电设备的实时状态监控，在大电流充电器的基础上，研究了加入CAN总线接口的通讯工作。利用CAN总线传输距离远，抗干扰能力强，易于扩展的特点，将充电器数据实时传送到上位机设备，上位机对充电器的电压和电流实时调整，实现充电最优化。详细分析了CAN总线工作原理和通讯协议的建立，最后通过搭建一个实验样机，验证了理论分析的正确性和可行性。</p><p>关键词 :充电设备，CAN总线，通讯协议，上位机</p><disp-formula id="hanspub.28911-formula18"><graphic xlink:href="//html.hanspub.org/file/3-2990224x6_hanspub.png"  xlink:type="simple"/></disp-formula><p>Copyright &#169; 2019 by author(s) and Hans Publishers Inc.</p><p>This work is licensed under the Creative Commons Attribution International License (CC BY).</p><p>http://creativecommons.org/licenses/by/4.0/</p><p><img src="//html.hanspub.org/file/3-2990224x7_hanspub.png" /> <img src="//html.hanspub.org/file/3-2990224x8_hanspub.png" /></p></sec><sec id="s3"><title>1. 引言</title><p>作为工业4.0关键部分，智能化是设备实现“四化”最重要的一环，而实现智能化就不得不给设备加上通讯接口，可以跟其他外设实现互连。</p><p>目前通讯接口有很多种类，例如RS485串口通讯 [<xref ref-type="bibr" rid="hanspub.28911-ref1">1</xref>] ，I<sup>2</sup>C通讯，CAN通讯，这些通讯方式各有特点，I<sup>2</sup>C通讯有时钟线、数据线和地线组成，通过上拉电阻方式来实现电平转换，地线的存在决定其在稍微远一点的通讯应用上会易受干扰，不可靠。而对于RS485或者CAN总线通讯就不会存在这一点，RS485和CAN总线都是两线式传输，采用差模方式进行通讯。在低速传输上，CAN传输距离会比RS485远，RS485在低速传输速率智能到1 km左右，而CAN可以达到10 km。在总线利用率上来比较，如表1所示，RS485总线上只能有一台主机，所以通讯都由它发出，而CAN通讯则是多主从架构，可以多节点发送和接收，利用率会高很多。在错误检测机制上，CAN总线也是完胜RS485总线，RS485只定义了物理层，没有数据链路层，所以限制了它错误机制的识别能力，CAN总线可以对总线上任何错误进行识别，保护总线，从安全的角度来说，CAN总线明显优于RS485。</p><p>本文将基于CAN总线通讯的方式，拟定一份充电器的通讯协议，对当前的充电器进行改造升级，使之具有数据的上传和接收远程控制的能力。这样带有CAN总线接口的充电器可以与电池的电池管理系统以及其他带有CAN总线接口的设备互联，有利于实现智能化充电。</p><table-wrap id="table1" ><label><xref ref-type="table" rid="table1">Table 1</xref></label><caption><title> Performance comparison from RS485 to CA</title></caption><table><tbody><thead><tr><th align="center" valign="middle" >特性</th><th align="center" valign="middle" >RS485</th><th align="center" valign="middle" >CAN-Bus</th></tr></thead><tr><td align="center" valign="middle" >通讯距离(低速传输)</td><td align="center" valign="middle" >&lt;1.5 km</td><td align="center" valign="middle" >可到10 km</td></tr><tr><td align="center" valign="middle" >系统成本</td><td align="center" valign="middle" >高</td><td align="center" valign="middle" >低</td></tr><tr><td align="center" valign="middle" >容错机制</td><td align="center" valign="middle" >无</td><td align="center" valign="middle" >有检错机制和处理</td></tr><tr><td align="center" valign="middle" >通讯失败率</td><td align="center" valign="middle" >高</td><td align="center" valign="middle" >低</td></tr><tr><td align="center" valign="middle" >数据传输率</td><td align="center" valign="middle" >低</td><td align="center" valign="middle" >高</td></tr><tr><td align="center" valign="middle" >网络架构</td><td align="center" valign="middle" >单主</td><td align="center" valign="middle" >多主</td></tr><tr><td align="center" valign="middle" >总线利用率</td><td align="center" valign="middle" >低</td><td align="center" valign="middle" >高</td></tr><tr><td align="center" valign="middle" >维护成本</td><td align="center" valign="middle" >高</td><td align="center" valign="middle" >低</td></tr></tbody></table></table-wrap><p>表1. RS485和CAN总线性能比较</p></sec><sec id="s4"><title>2. CAN通讯的工作原理</title><sec id="s4_1"><title>2.1. CAN通讯的背景和当前应用状况</title><p>CAN总线是一种用于实时传输的串行通讯协议总线，可以使用双绞线来传输信号，最早应用于汽车里各种设备间的通信，是由德国博世公司开发而来，用来取代昂贵并且笨重的配电线束，目前已广泛用于电梯控制系统、医疗仪器、纺织机械、船舶运输等领域。实时性强，传输距离远，抗干扰能力强等特点，使CAN总线规范成为国际标准，被认为是最有前途的总线技术之一。</p></sec><sec id="s4_2"><title>2.2. CAN总线架构以及工作方式</title><p>CAN总线通讯采用3层模型：物理层、数据链路层和应用层 [<xref ref-type="bibr" rid="hanspub.28911-ref2">2</xref>] 。传输介质为双绞线、同轴电缆和光纤等，速率通常为1 Mbps/40 m，50 Kbps/10 km，结点数可以达到110个。CAN的通信介质访问带有优先级的CS-MA/CA，采用多主竞争方式结构：网络上任意结点均可以在任意时刻主动地向网络上其它结点发送信息，而不分主从，即当发现总线空闲时，各个节点都有权使用网络。在发生冲突时，采用非破坏性总线优先仲裁技术，当几个节点同时向网络发送消息时，运用逐位仲裁原则，借助帧中开始部分的标识符，优先级低的节点主动停止发送数据，而优先级高的节点可不受影响的继续发送信息，从而有效地避免了总线冲突，使信息和时间均无损失。</p><p>CAN总线系统主要由实现CAN总线协议的控制器和微处理器电路组成，如图1所示，通过物理层的连接可以完成数据链路层的所有功能，其中应用接口主要是由微处理器完成，总线上的节点都是基于微处理器的智能节点。</p><p>图1. CAN总线系统</p><p>CAN总线采用总线式网络拓扑结构 [<xref ref-type="bibr" rid="hanspub.28911-ref3">3</xref>] ，这种架构结构简单，成本低，通过总线连接各个网络节点，形成多主机方式的控制局域网，通过规定响应的通信协议，通过CAN控制器来完成数据的传输。</p></sec></sec><sec id="s5"><title>3. 智能快充的CAN总线通讯设计</title><sec id="s5_1"><title>3.1. CAN总线通讯的硬件设计</title><p>为了验证CAN总线在智能快速充电器的应用可行性，本文将在快速充电器上嵌入了CAN通讯接口和微处理器，对实时通讯结果进行验证，整个通讯架构如图2所示。</p><p>对于收发器模块，本文采用Philips Semiconductors的TJA1040芯片方案，如图3所示，这款芯片工作稳定，性价比高，广泛应用于工业生产中。在CAN接口部分会加入双向稳压管来应对接口端子使用过程中带来的静电或者雷击，保护芯片。</p><p>图2. 充电器CAN通讯架构</p><p>图3. CAN收发器模块</p><p>图4. 微处理器模块</p><p>对于微处理器模块，我们采用ST公司的STM32系列单片机，型号为STM32F042F4P6，如图4所示，这款芯片自带CAN接口，分别是PA9和PA10，无需外接晶振。同时这款芯片可以提供PWM接口用于调节充电器的电压和电流，并利用AD接口采样电压、电流和温度，可实现实时监控和调节。成本低和接口丰富使得这款芯片是不二选择。</p></sec><sec id="s5_2"><title>3.2. CAN总线通讯的软件设计</title><p>对于快速充电器和电池管理系统或者其它外设之间的通讯内容，需要有标准的协议来执行。对于充电器本身对外发送数据的协议，初步拟定如表2所示，对于充电器接受数据协议如表3。</p><table-wrap id="table2" ><label><xref ref-type="table" rid="table2">Table 2</xref></label><caption><title> CAN protocol sent by super Li charge</title></caption><table><tbody><thead><tr><th align="center" valign="middle"  colspan="2"  >报文2 (ID:0X112)</th><th align="center" valign="middle" >数据方向：从快速充电器到电池管理系统</th></tr></thead><tr><td align="center" valign="middle" >位置</td><td align="center" valign="middle" >数据名</td><td align="center" valign="middle" >描述</td></tr><tr><td align="center" valign="middle" >Byte0</td><td align="center" valign="middle" >输出电压高字节</td><td align="center" valign="middle"  rowspan="2"  >0.1 V/bit偏移量：0 例：3201对应320.1 V</td></tr><tr><td align="center" valign="middle" >Byte1</td><td align="center" valign="middle" >输出电压低字节</td></tr><tr><td align="center" valign="middle" >Byte2</td><td align="center" valign="middle" >输出电流高字节</td><td align="center" valign="middle"  rowspan="2"  >0.1 V/bit偏移量：0 例：581对应58.1 A</td></tr><tr><td align="center" valign="middle" >Byte3</td><td align="center" valign="middle" >输出电流低字节</td></tr><tr><td align="center" valign="middle" >Byte4</td><td align="center" valign="middle" >状态位</td><td align="center" valign="middle" >充电器发送指令原因</td></tr><tr><td align="center" valign="middle" >Byte5</td><td align="center" valign="middle" >保留</td><td align="center" valign="middle" ></td></tr><tr><td align="center" valign="middle" >Byte6</td><td align="center" valign="middle" >保留</td><td align="center" valign="middle" ></td></tr><tr><td align="center" valign="middle" >Byte7</td><td align="center" valign="middle" >保留</td><td align="center" valign="middle" ></td></tr></tbody></table></table-wrap><p>表2. 锂电池快充上报CAN协议</p><table-wrap id="table3" ><label><xref ref-type="table" rid="table3">Table 3</xref></label><caption><title> CAN protocol received by super Li charge</title></caption><table><tbody><thead><tr><th align="center" valign="middle"  colspan="2"  >报文1 (ID:0X111)</th><th align="center" valign="middle" >数据方向：从电池管理系统到快速充电器</th></tr></thead><tr><td align="center" valign="middle" >位置</td><td align="center" valign="middle" >数据名</td><td align="center" valign="middle" >描述</td></tr><tr><td align="center" valign="middle" >Byte0</td><td align="center" valign="middle" >最高允许充电端电压高字节</td><td align="center" valign="middle"  rowspan="2"  >0.1 V/bit偏移量：0 例：3201对应320.1 V</td></tr><tr><td align="center" valign="middle" >Byte1</td><td align="center" valign="middle" >最低允许充电端电压高字节</td></tr><tr><td align="center" valign="middle" >Byte2</td><td align="center" valign="middle" >最高允许充电电流高字节</td><td align="center" valign="middle"  rowspan="2"  >0.1 V/bit偏移量：0 例：581对应58.1 A</td></tr><tr><td align="center" valign="middle" >Byte3</td><td align="center" valign="middle" >最低允许充电电流高字节</td></tr><tr><td align="center" valign="middle" >Byte4</td><td align="center" valign="middle" >控制位</td><td align="center" valign="middle" >0：允许开机，1：关闭充电器</td></tr><tr><td align="center" valign="middle" >Byte5</td><td align="center" valign="middle" >状态位</td><td align="center" valign="middle" >BMS发送指令原因</td></tr><tr><td align="center" valign="middle" >Byte6</td><td align="center" valign="middle" >保留</td><td align="center" valign="middle" ></td></tr><tr><td align="center" valign="middle" >Byte7</td><td align="center" valign="middle" >保留</td><td align="center" valign="middle" ></td></tr></tbody></table></table-wrap><p>表3. 锂电池接收CAN协议</p></sec></sec><sec id="s6"><title>4. CAN总线通讯测试结果</title><p>CAN总线通讯测试结果与理论分析基本一致，图5和图6分别是上位机通过USB-CAN发送接收数据的操作界面，发送和接受的数据与通讯协议一致。</p><p>图5. 长时间无指令发送界面</p><p>长时间无指令发送时，充电器认为是总线通讯有故障，所以第五位报通讯故障，显示0x10，电压电流显示为0。</p><p>图6. 充电过程中发送接收界面</p><p>当发送指令“02 1C 00 30 00 00 00 00”给电池充电器时，如图6所示，Can接收器接收到数据为“02 0F 00 31 00 00 30 00”，显示电压为52.7 V，电流为4.9 A，与设定电流4.8 A差值0.1 A，满足设计要求。</p><p>结合智能快速充电器测试实际电流电压波形如图7和图8所示，当充电器接受到开机指令，会打开充电器以默认的4 A电流充电，当接收充电电流加到6 A时，电流立即切换到6 A并稳定运行，图7显示从开机到关机整个动态过程，这个过程均由电脑结合CAN收发器远程控制，图8显示电池从正常充电切入和切出到小电流充电电池维护的过程。</p><p>图7. 充电电流动态切换</p><p>图8. 充电小微电流动态切换</p></sec><sec id="s7"><title>5. 总结</title><p>本文研究了CAN总线通讯的工作原理，通过几种通讯方式的比较得到CAN总线通讯优势，并结合智能快速充电器的实际应用，在快速充电器硬件内部嵌入了CAN收发器和微处理器，实现了充电器的数据接收和发送，最后进行了测试验证。实验结果表明，低成本的CAN总线通讯非常适合快速充电的应用。</p></sec><sec id="s8"><title>文章引用</title><p>程 宇,陈世杰. 智能快速充电设备的CAN总线通讯设计Communication Design Based on CAN Bus for Quick Smart Charger[J]. 仪器与设备, 2019, 07(01): 15-22. https://doi.org/10.12677/IaE.2019.71003</p></sec><sec id="s9"><title>参考文献</title></sec></body><back><ref-list><title>References</title><ref id="hanspub.28911-ref1"><label>1</label><mixed-citation publication-type="other" xlink:type="simple">刘小强, 粟梅. 基于CAN总线的数据采集处理系统的设计[J]. 仪表技术与传感器, 2006(9): 22-24.</mixed-citation></ref><ref id="hanspub.28911-ref2"><label>2</label><mixed-citation publication-type="other" xlink:type="simple">满庆丰. CAN总线的应用与发展[J]. 电子技术应用, 1994(12): 2-4.</mixed-citation></ref><ref id="hanspub.28911-ref3"><label>3</label><mixed-citation publication-type="other" xlink:type="simple">韩成浩, 高晓红. CAN总线技术及其应用[J]. 制造业自动化, 2010, 32(2): 146-149.</mixed-citation></ref></ref-list></back></article>