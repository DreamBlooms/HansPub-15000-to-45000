"通过对USB2.0及1394接口数据传输的优缺点比较，结合角膜地形图仪图像采集传输的要求，设计了面阵CCD的驱动及USB2.0数据采集传输系统。在该系统中，选用Sony公司IXC445ALA面阵CCD作为系统图像采集的传感器，根据ICX445ALA的驱动时序要求，利用AD模数转换和CPLD的时序框架及单片机时序控制，实现了驱动电路的设计。针对单片机的USB2.0固件驱动，完成了USB2.0的数据输出。通过控制单片机的I/O口，实现了LED背光源的开闭、左右眼的自动判别及角膜图像的获取。最终检测表明，所获得的角膜图像清晰，USB2.0数据传输快速稳定，单片机辅助功能工作正常。较好地实现了角膜地形图仪中图像采集传输的要求。 关键词 :角膜地形图仪，图像采集传输，USB2.0，ICX445ALA，CPLD"
"角膜地形图仪是检测人眼角膜表面形态的重要视光学测量仪器，通过采集人眼角膜表面形貌的图像，并将所采集到的图像传给上位机图像处理软件进行相应的处理，得到人眼角膜表面形貌的信息，为眼科医生测量角膜表面形貌及之后的角膜屈光校正或手术治疗提供了有力的检测手段 [ 1 ] - [ 3 ] 。因此，角膜地形图仪中图像采集及数据传输系统是整个设备的重要部分。目前市场上存在着多种型号的角膜地形图仪，其原理大都是由CCD将Placido盘反射的图像采集下来 [ 4 ] [ 5 ] ，根据模型实现人眼角膜形貌的重构。而现有仪器的数据传输一般都采用的1394卡，相比于1394卡传输，USB2.0数据传输具有易用性、稳定性及未来可持续升级等特点。现今PC机上都带有多个USB接口，并用于各种数据传输，且传输速率足以满足角膜地形图仪中对图像快速传输的要求。较要将1394卡安装到台式PC机上进行图像快速传输的适用性更加强。利用USB数据传输是现今社会的主流，且USB接口协议正在不断升级，USB3.0正在成为新一代电脑和电子产品的标准配置，越来越多的平板也支持USB数据传输，并可为以后角膜地形图仪的小型化及易用性的打下了坚实的基础。 根据角膜地形图仪成像系统对光谱响应 [ 6 ] 、传输帧频、分辨率及数据传输的要求，选择面阵CCD传感器ICX445ALA作为图像采集设备。设计了AD和CPLD的时序框架 [ 7 ] - [ 10 ] 及单片机STM32的时序控制，实现了驱动电路的设计。利用USB2.0的固件驱动 [ 11 ] [ 12 ] ，完成了USB2.0的数据输出。控制单片机的I/O口，实现了LED背光源的开闭、左右眼的判别及图像的自动获取。最终检测表明，CCD图像清晰，USB2.0数据传输快速稳定，单片机辅助功能工作正常。"
"图1所示为角膜地形图仪图像采集系统原理结构图。由环形阵列LED光源发出的光经漫反射后，照亮在一定距离外的眼球，并将Placido盘上的黑白条纹投射到角膜上，在人眼角膜上形成黑白条纹的像，经角膜反射后由透镜成像系统聚焦成像到CCD传感器上。由CCD传感器采集到的电信号经过驱动脉冲 图1. 角膜地形图仪成像系统原理图 作用下转移输出，并通过USB2.0传输到上位机，经过软件处理实现人眼角膜表面形貌的重构及各种数据处理。"
"选用SONY公司生产的ICX445ALA面阵CCD芯片作为角膜地形图仪中图像采集的传感器。CCD芯片中信号电荷的转移以及信号电荷的输出必须在驱动脉冲的作用下才能完成。利用单片机STM32、AD9949A及CPLD芯片实现CCD的驱动及数字信号采集，AD9949A与CPLD之间通过垂直同步、水平同步和基准时钟实现同步。通过配置AD内部寄存器，实现图像数字信号的采集，利用USB2.0的固件驱动结合单片机的控制实现与PC机之间的数据通信，满足了系统设计要求。  采集系统中CCD驱动电路框图如图2所示。CCD的水平时钟信号和复位时钟信号由AD9949A提供，CPLD提供CCD的垂直时钟信号和选通信号，AD9949A和CPLD间的同步分别由垂直同步、水平同步和基准时钟实现。选用Altera公司的EPM240T100C5N CPLD芯片产生的时序电平不能满足面阵CCD传感器中的垂直移位寄存器的驱动电压(不为+5 V)，因此需要外加垂直时钟驱动芯片CXD3400n与之相匹配，将原本为TTL电平的XSG1、XSG2、VΦ1A、VΦ1B、VΦ2A、VΦ2B、VΦ3A、VΦ3B、VΦ4A、VΦ4B和ΦSUB信号转变成具有−8 V/0 V/+15 V三个等级的信号。其中XSG1、XSG2时序信号实现感光阵列中的电荷信号转移。由单片机STM32与AD9949A实现数字信号的获取，并通过STM32配置传输给USB2.0进行采集输出。  CPLD采用硬件描述语言VERILOG来实现芯片ICX445ALA垂直时钟驱动时序和同步时钟驱动时序。这些时序信号为：XSG1、XSG2、VΦ1A、VΦ1B、VΦ2A、VΦ2B、VΦ3A、VΦ3B、VΦ4A、VΦ4B和ΦSUB。其中VΦ1A、VΦ1B、VΦ2A、VΦ2B、VΦ3A、VΦ3B、VΦ4A、VΦ4B是CCD中垂直寄存器转移时钟，控制垂直移位寄存器中的电荷信号移动。同时为了实现与AD间同步，添加同步信号VD、HD及时钟基准信号CLK。 图2. 采集系统中CCD驱动电路框图 应用Verilog硬件描述语言完成驱动时序的逻辑设计，采用QuartusⅡ软件系统进行了驱动时序发生器的功能仿真，仿真效果如图3所示。  STM32提供了USB2.0全速接口模块，可支持最大传输速率12 Mb/s。针对该系列微控制器的USB2.0全速模块为其提供了一个完整的固件库和软件包USB-FS-Device开发套件。 USB2.0的固件库分别由内核层和应用接口层两部分组成，该固件库结构框图如图4所示。其中内核层管理应用USB标准协议与USB IP硬件实现两者间通信。在USB内核层中，可以使用构造函数指针的办法调用回调函数，通过该方式将USB内核层与应用接口层连接起来。应用接口层为用户提供了内核和最终应用之间的完整接口，对于不同设计方案可以对该层进行更改。通过对设备描述符、配置描述符、接口描述符和端点描述符及设备复位函数修改，添加相应的端点传输中断服务程序。实现本系统中USB2.0的数据采集。"
"为了满足角膜地形图仪采集系统中CCD成像要求，获取清晰的Placido盘在人眼角膜上的像，图像采集工作更容易进行，设计了LED背光源及左右眼判别等辅助控制电路。并通过控制单片机的I/O口，实现LED背光源的开闭、左右眼的自动判别及图像采集状态的控制。  为满足CCD成像系统获得清晰明亮黑白相间的图像，在Placido盘的后表面提供灯光照明。光源采用60颗红色LED灯，排列成内圈6颗，中间14颗，外圈40颗的三组同心环形作为光源发光元件。红色LED具有高亮度、高发光效率、高单色性及寿命长等特点 [ 13 ] [ 14 ] ，同时满足CCD的光谱敏感要求，且对人的眼睛不会产生伤害。为实现LED照明亮度的稳定性，设计了一款开关稳压供电电路，该供电电路不仅能为LED供电，而且能够通过单片机的I/O口实现LED灯的开闭，既能够保护LED灯的使用寿命，又能节省电能。开关稳压供电电路原理图如图5所示。 整个电路由两部分组成，基于CS5173控制芯片的单端初级电感转换器(SEPIC)电路与开关控制电路。SEPIC电路用来实现对输入电压升降转变，开关控制电路控制LED灯的供电。  角膜地形图仪对人眼进行测量时，由于人左右眼在结构及病理上的不同，在实际测量中要进行左右眼的标注，因此设计左右眼的判断电路就变得非常重要。其电路原理如图6所示。 图3. CCD驱动时序仿真图 图4. USB固件应用框图 红外LED发光管D1发出的光由反射面(由黑白两色组成，正中间是一块10*15 cm的白色区域，其余部分为黑色)。反射后被集成芯片IS471F接收。IS471F具有内置信号处理电路的光调制系统的光检测器件，该芯片对不同颜色的反射面反射光强差异产生不一样的电压值，白色为0 V，黑色为3 V。根据芯片IS471F接收的高低电平，从而获得左右区域的信息，然后将电平高低信号经过输入输出口存储在寄存器中，通过读取寄存器值就可以进行左右眼的识别。"
"本文在分析面阵CCD传感器ICX445ALA驱动时序的基础上，由AD提供CCD的水平驱动信号，CPLD提供垂直驱动信号，实现了ICX445ALA的驱动设计，利用USB2.0的固件驱动结合单片机的控制实现与PC机之间的数据通信。并根据角膜地形图仪对图像采集的要求，设计外部辅助控制电路。验证表明，该设计能够实现角膜地形图仪的图像采集、数据传输及辅助控制。通过搭建整个角膜地形图仪系统，如图7所示，采集到的模拟眼及真实人眼图像如图8、图9所示，较好地实现了角膜地形图仪中图像采集传输的要求。 图5. LED背光源控制电路图 图6. 左右眼判别电路原理图 图7. 角膜地形图仪系统 图8. 模拟眼图像 图9. 真实人眼图像"
