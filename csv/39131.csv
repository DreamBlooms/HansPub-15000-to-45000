"在舞台美术中，光和色的组合是表现人物内心的重要因素；通过调整光比、设计用色可以创造舞台的空间感、时间感等客观因素和人物内心的主观表现。调整光比即控制舞台灯具设备的传统方法是采用单向控制的设备控制协议Digital Multiple X 512，而作为DMX协议增强的Remote Device Management协议采用双向通信，具有更为强大的功能。本文在STM32硬件系统基础上，搭载实时操作系统freertos，完成了基于RDM协议的舞台灯具控制系统，扩展了传统舞台灯具控制系统的功能。"
"在舞台美术中，灯光艺术作为传递视觉效果重要手段之一 [ 1 ]，舞台上灯光的各种状态，变化以及色彩颜色触动或引起观众的心理种种变化，是因为色彩的感观效果非常直接，而又能有力地表现情感 [ 2 ]。有色光颜色的选择，灯光设计者遵循人类对客观世界的主观感受习惯，通过调整光比，设计用色来创造舞台的空间感、时间感等客观因素和人物内心的主观表现 [ 1 ]。 调整光比即控制舞台灯具设备，目前在舞台控制中DMX512控制协议使用最普遍，物理层采用RS-485设计 [ 3 ]，但DMX512有单向传输，无法获得灯具状态、信息和无法配置设备等缺点，美国战区技术研究所(USITT)提出的RDM协议是对DMX512协议的增强，RDM协议允许对舞台设备进行配置、状态监视和管理 [ 3 ]。为了更好控制舞台，方便舞台设计，本文设计了基于stm32和实时操作系统freertos的RDM灯具控制系统。"
"据心理学研究，光色与人们的情绪有关，光的波长不同、颜色的感觉也不同。光进入眼帘后产生的感觉，这种感觉进一步被大脑判断，开始感到颜色就是心理现象 [ 2 ]。 暖色与冷色是依据心理错觉对色彩的物理性分类 [ 1 ]，亮色颜色更容易和积极情绪联系，而暗色容易跟消极颜色联系 [ 4 ]。红色的视觉穿透力最强，让人感到兴奋、炎热、活泼、热情、充实、饱满, 有种挑战的意味 [ 5 ]；黄色是亮度最高的颜色，它具有警告的效果，又象征着财富、权利、智慧、辉煌等；黑色象征着高雅、权威，黑色意味着空无，像太阳的毁灭，像永恒的沉默，没有未进展，而与之对立的白色象征着纯洁与神圣等。色彩心理学不仅能更好的服务于舞台灯光，而色彩心理学本身有着很大的发展空间，非常值得去深入发掘，横向的运用于舞台美术的各个专业 [ 1 ]。  RDM是远程设备管理协议，以DMX512-A为基础 [ 6 ]。一次完整波形如图1所示。 图1. Dmx-rdm数据包波形 RDM与DMX传输主要区别有表1： Table 1 协议 DMX RDM 传输方向 单向 双向 Break时间 88~352 us 176~352 us 数据槽0值(起始码) 0× 00 0 × CC 数据长度 不定长，最长257字节 定长，513字节 表1. Dmx-rdm数据区别 除了表1中的主要区别外，RDM设备回应上位机指令时有两中数据包格式，RDM控制命令定义为三类：设备查找、设备信息收集、设备设置命令类，其中回应设备查找命令时数据包不需要发送break信号，多设备回应时break信号会使所有数据无效，而其他命令只会有指定id的设备回应。"
"如图2所示，主控板使用STM32F103VCT6为核心，共有电源模块、485模块、OLED显示屏、按键模块、升压模块和温度模块组成。主控板由12 V电源进行供电，电源模块将12 V进行5 V、3.3 V等供电适配；手动状态时用户操作按键进行控制，相应操作结果反馈在显示屏上；DMX-RDM控制时，485模块将485电平转换，便于串口通信；由于主控板输出PWM波控制灯、风扇时电压可能不够，需要通过升压模块进行适配。 图2. 系统框图  系统软件是基于实时操作系统freertos完成的，整个系统由开始任务、RDM任务、485管理任务、485中断任务、OLED显示任务、PWM控制任务等组成。开始任务会将其他任务全数创建，并将自己删除以节省系统资源，系统会进行任务调度执行其他任务。如图3所示为主函数流程图。  图4所示为RDM任务流程图，RDM任务是RDM的数据校验、分析任务，RDM任务首先初始化错误等标志、数据长度参数和申请缓存空间，然后初始化RDM驱动函数，并负责阻塞等待485中断函数将数据放入消息队列中，然后解析RDM数据。RDM数据验证子程序是用于判断接收到的RDM不定长数据符合校验和，校验和正确后判断是否指定目标UID符合回应条件；验证成功后RDM解析子程序将会进行数据解析并进行相应的处理后回应。 图3. 主函数流程图 图4. RDM任务流程图  图5所示为485管理任务流程图，DMX、RDM驱动函数初始化完成后，485管理任务才能进行创建运行，485管理任务首先初始化通知值、485开关等标志参数后初始化485驱动，485中断函数开启，之后阻塞接收任务通知，所有跟RDM、485相关的任务通知都会集中在这个任务中处理。 图5. 485管理任务流程图  图6所示为中断流程图，485中断函数是使用串口中断，接收DMX和RDM时由于需要捕获break信号，串口使用lin模式可以捕获前导break信号，虽不能确定break时间，但可以减少硬件资源和系统定时器资源，还可以用数据包的首数据槽即起始码来区别DMX与RDM的信号。 每个设备默认需要的DMX槽数都是固定的，DMX起始地址会在之前预先配置好，DMX数据固定为513长度，可直接判断从DMX起始地址开始接收固定槽数的数据，并通过DMX消息队列发送给PWM任务进行控制；而RDM是不定长的数据，在RDM通信时总会有一段空闲时间，可以通过串口的空闲中断来判断RDM已经传送完成，在将接收完成的RDM数据通过RDM消息队列发送给RDM任务进行解析回应。 图6. 中断流程图  图7为控制板实物图，四个按键可以直接手动控制灯具所有通道的数值，并能设置地址值，OLED屏幕可以显示所有操作、温度，同时如果有DMX、RDM信号也能在界面上显示，图7中右部分为连接测试图，测试时使用DMX-RDM测试平台软件发送命令，使用keil和stlink进行主控板仿真。 图7. 实物图 图8、图9为与DMX协议相关的测试图，图8中测试平台发送DMX数据，数据槽0是起始码0，主控板设置地址为1，固定接收8个槽数据，图9中dmx_buf从dmx数据队列中成功接受到8个数据，与测试平台发送DMX数据包中1-8槽数据相同。 图8. DMX协议测试图 图9. DMX任务测试图 图10~13为RDM相关的测试图，图10中测试平台执行查找程序，在二分查找的过程中接收到主控板的回应数据，最后成功解析数据，获得主控板id。图11为RDM任务接收数据，rdm_buf在RDM数据队列中获取数据后，经过校验后输入解析RDM子程序。图12为查找命令回应数据，在图中回应数据与测试平台接收的数据一致，图13为RDM其他命令回应数据，头数据为0xCC，与测试平台接受到数据格式是一致的。从所有的测试看，本系统能够可靠接收DMX、RDM信号，并能正确解析并执行命令，达到了预期效果。 图10. RDM协议测试图 图11. RDM任务测试图 图12. RDM查找命令回应图 图13. RDM其他命令回应图"
"本文给出一个支持RDM协议的舞台灯具控制系统的开发过程及其技术实现，扩展了传统舞台灯具控制系统的功能。系统开发时出现了不少问题，一是freertos移植开发，在freertos移植过程中的一些参数修改和配置，还有在freertos开发时任务、队列、中断等的配合使用；二是DMX-RDM协议中都会有前导break信号，它们的时间是无法确定且范围有交集，RDM协议通信时是不定长的；三是RDM驱动中采集、设置命令与各个模块的配合等。支持RDM功能舞台设备能让舞台设计时控制更加方便，为远程控制舞台提供了基础，本系统还存在不足的地方，但相信在未来开发中会得到完善和改进。"
