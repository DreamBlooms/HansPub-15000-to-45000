"中国散裂中子源(CSNS)硼中子俘获治疗(BNCT)实验装置加速器主体由一套速调管功率源和一台RFQ腔体组成，用于给带电粒子提供加速能量。其中，数字低电平控制系统(LLRF, Low Level Radio Frequency control system)用于控制速调管功率源的功率大小，并实现自动老炼、驻波比保护、ARC保护、调频、调谐等功能。本文详细介绍了各个系统的功能以及最终实现的情况。"
"硼中子俘获治疗(BNCT)将强靶向性的含硼药物施于癌细胞并滞留其中，然后用热中子照射，使硼原子与热中子发生俘获反应。硼中子俘获治疗(BNCT)最突出的优点是在杀死癌细胞的同时最大限度地保护正常细胞。目前最成熟的BNCT药物BPA可应用于头颈癌、黑色素瘤、骨肉瘤、脑及CNS肿瘤、乳癌等。特别适用于浸润、扩散、转移等X-射线、质子、重离子以及手术无法治疗的癌症。BNCT因靶向深入治疗、毒副作用少、成本相对低廉等已成为肿瘤治疗的热点 [ 1 ] [ 2 ]。由于加速器的中子束具有能量可调节的特点，且加速器同时具备反应堆所不具备的安全优势。基于强流质子加速器的技术日益得到各国的重视。基于加速器的中子源能够满足BNCT对中子产额以及中子穿透深度的要求，并以其较低的建造维护费用和便捷安全稳定的运行方式，很有可能成为医院普及使用的BNCT中子源 [ 3 ] [ 4 ] [ 5 ]。 如图1所示，东莞(中国散裂中子源)第一套BNCT实验装置(简称：D-BNCT01)由一台ECR质子源、 图1. D-BNCT01主体结构示意图 一条低能传输线、一台3.5 MeV射频四极加速器(RFQ)、一条高能传输线(HEBT)和一个治疗端组成 [ 6 ]。射频四极加速器(RFQ) [ 7 ] 由速调管功率源提供功率。低电平控制系统用于控制速调管的输出功率，同时实现高功率监测和保护以及自动老炼、变频、发布变量等功能，是加速器中关键的控制设备之一。"
"图2为低电平控制系统整体框图，LLRF硬件组成主要包括上下变频模拟组件、低电平数字电路、高功率驻波比保护数字电路、快保护数字电路、打火探测器等。按功能划分主要包括幅相控制频率调制子系统、自动老炼子系统、功率测量和驻波比保护子系统、弧光打火(ARC)和Lowwattcher快保护子系统等。 图2. D-BNCT01 LLRF框图 如图2所示，从腔体Pick_up的352.2 MHz信号和340.46 MHz本振信号混频得到11.74 MHz中频信号送到ADC进行IQ采样。ADC采样频率为46.96 MHz，采样信号经过IQ解调以后波形将IQ值送到软件界面进行幅度相位显示，FPGA中不需要使用CORDIC (Coordinate Rotation Digital Computer)算法来进行幅度相位的转换，减少FPGA资源使用。 上位机发送的IQ值给FPGA，通过NCO进行调制实现变频，变频以后送到DAC输出11.74 MHz中频信号，中频信号再通过射频前端的混频模块上变频到352.2 MHz送给速调管作为速调管的驱动信号。 RFQ腔体有4个射频馈入口，在各个馈入口的波导上安装定向耦合器由于功率监测和正反向信号波形采样。在其中3个馈入口波导上安装移相器，通过调节三个移相器相位，最终使得四个馈入口的相位一致。 功率测量和驻波比保护子系统测量4个馈入口出的定向耦合器，并实时计算驻波比值，当腔体打火进行切激励，对腔体和功率源起到保护作用。 打火探测器监测速调管输出窗和环形器两个重要设备的弧光放电情况。 由于RFQ腔体可以进行任意相位的加速，且后续没有DTL腔体，所以RFQ对功率源的输出相位没有要求，此外，开环工作幅度的稳定度也满足束流要求，为此，低电平控制系统放弃相位和幅度闭环反馈作用，采用开环变频的方式工作。低电平输出信号实时跟踪腔体频率，尽管RFQ腔体谐振频率随着射频功率大小及占空比变化而变化 [ 8 ]，但是通过这种方式总能保证反射总是最小。RFQ水温调节腔体频率仅仅作为粗调，不需要实时动作。"
"RF幅度控制系统前端采用上下变频的方式现实频率转换，主控制电路采用如图3所示数字控制电路。数字控制电路配备有一个FPGA和两个DSP(其中一个备用)芯片，FPGA用于逻辑运算，DSP用于建立和工控机UPD/IP连接和进行一些复杂的数学运算，RF幅度控制系统主电路板配备一块4通道ADC子板和一块4通道DAC子板。ADC子板中3路ADC分别采集腔场和一路定向耦合器的正反向功率电压，DAC子板中一路DAC用于输出中频信号。LLRF电路负责对腔压进行采样、IQ解调、波形上传、调频、限幅等。 图3. 数字控制电路 数字I/Q解调的想法就是通过测量一个特定正弦波复矢量的I分量和Q分量，以此就可以获得该正弦波信号的振幅和相位信息。 正弦波的振幅： A = I 2 + Q 2 正弦波的相位： φ = tan − 1 ( Q I ) 低电平控制系统中的数字I/Q解调技术，通过特殊的A/D采样方法来实现，在A/D采样部分曾经提到过，腔体中频IF为11.74 MHz，A/D采样时钟为46.96 MHz，因此在一个中频周期内采样四次。 由于采样频率为腔体采样中频频率的四倍，因此两个相邻的采样点之间的相位间隔为 π 2 ，假设第一个采样点为： D 1 = A cos ( ω t + φ ) = I 第二个点： D 2 = A cos ( ω t + π 2 + φ ) = A sin ( ω t + φ ) = Q 第三个点： D 3 = A cos ( ω t + π + φ ) = − I 第四个点： D 4 = A cos ( ω t + 3 2 π + φ ) = − Q 后续的采样点依次按照[I, Q, −I, −Q]的格式重复出现，根据腔场幅度和相位与I/Q信号的关系，就可以求得加速腔中腔场的振幅和相位信息。 由于束流负载效应 [ 9 ] 的作用，加速器出束以后，腔体内的电磁场能量被束流带走，会导致腔体能量减少，为了保证束流能量足够，设计了前馈补偿束流能量的功能。通过界面设置合适的前馈矢量，计算机将前馈矢量转换为I/Q值写入到FPGA中，同时接收束流同步信号，在束流到来时把前馈I/Q值叠加到DAC输出I/Q值上，如图4所示。 图4. 前馈补偿原理图  速调管功率源通过一分二、二分四给RFQ腔体4个高功率耦合器馈入功率，每路入腔功率的波导上放置1~2个定向耦合器，每个耦合器都有正向和反向监测通道，正反向功率信号接到检波器进行检波然后送到数字电路进行ADC采样和逻辑计算和判断。检波器采用mini-circuit型号为ZX47-40-S+，具有高线性度、低延时的优点，图5为检波器外观和线性度测量。功率测量和驻波比保护子系统能实时显示功率和驻波比值，同时实时存储驻波比保护计算次数，可以用于对打火进行分析。保护响应时间小于5 μs，图6为测试结果。 驻波比保护系统在监测到驻波比过大时，会切掉当前脉冲，在K个脉冲以后恢复功率，如果连续严重，单位时间内(例如，5秒)打火次数大于设定的阈值，就会关闭功率，等待人工恢复。其中K如果等于1就是下一个脉冲就恢复功率。 图5. 功率检波器。(a) 功率检波器照片；(b) 检波器线性度测量 图6. 射频保护响应时间测试 由于腔体打火会导致腔体内释放出气体导致真空恶化，操作者可以根据真空恶化程度调节K的值进而调整恢复功率的时间，这样能保证真空设备有足够时间吸收腔体内的气体杂质，减少由于真空恶化以后出现连续的打火导致宕机的概率。  RFQ刚加工完成只能通过老炼才能慢慢往腔体馈入功率，自动老炼系统采用驻波比保护系统的打火计数次数作为依据自动控制入腔功率，实现自动老炼功能 [ 10 ]。图7是自动老炼的程序结构图，如果单位时间驻波比保护次数大于一定值(>M)则进行降功率；如果单位时间驻波比保护次数在一定区间内(N~M)，则保持功率不变，等待下一个周期升功率；当单位时间驻波比保护次数小于一定数值( 当自动老练则在达到满功率以后，维持一定时间之后按照一定时间、一定的步长台阶式降功率，到达最低功率以后，维持一定时间之后，在按一定时间、一定步长进行升功率，达到最高功率以后进行再进行维持，反复进行老练，确保在不同的功率区间都能老练到位。驻波比响应时间达到微秒级别，而真空响应时间均大于10 ms，采用驻波比作为老炼依据有响应更及时的优点。 图7. 自动老炼算法流程图  直线功率源工作在脉冲模式下，每个脉冲RF驱动结束之后腔场会有自由衰减振荡的尾场，这个尾场频率实时反映了腔体的谐振频率 [ 11 ]，由于使用固定的采样频率进行采样，当尾场振荡频率与工作频率352.2 MHz不一致时，相位值是线性变化的，相位的斜率为： d θ d t = 2 * p i * Δ f 其中 Δ f 是偏离中心频率的频率值。将频率为( f 0 + Δ f )的功率馈入腔体，可以避免由于腔体失谐导致的反射过大。图8红色线为腔体在低电平变频情况下腔体相位情况。 由于腔体失谐过程比较缓慢，一般是几秒才有比较明显变化，因此失谐变频算法在软件上实现，通过计算尾场相邻两点相位的斜率并对其排序以后取中间值，可以排除掉原始数据中相位经过±180˚时跳变的数据，并获得合理的失谐频率值。 图8. 自动变频条件下的相位情况(红色)  弧光放电保护系统利用监测弧光对系统起到保护作用，分别在速调管输出窗和环形器输出位置各放置一路ARC打火探测器。ARC探测器保护逻辑包含两个层面，第一个层面，在射频脉内出现监测到ARC现象时，对当前射频脉冲进行封锁，由于每次ARC探测器输出的脉冲为500 ms，所以500 ms内不再恢复射频脉冲，等到500 ms结束以后恢复射频脉冲。同时界面上可以设置累计保护次数，如果5秒内出现ARC次数超过一定数值，则进行永久保护，等待人工复位。 当速调管反射过大时，需要进行切射频保护，以免对速调管造成损伤。采用LM393电路实现低通滤波和比较判断的功能。由于BNCT工作的重复频率和脉冲宽度随着项目进展不断调整，实验中，发现在同样幅度的射频脉冲输入条件下，不同的重复频率和脉冲宽度对输入比较结果也不一样。这与反射保护固定阈值要求相违背。最终不断优化电路结果保证在不同占空比下阈值固定不变。"
"远程界面通过在本地程序嵌入EPICS实现PV分布 [ 12 ]，如图9所示，远程界面包括幅度、变频控制，功率监测及驻波比保护、打火探测器、自动老炼及腔体波形实时显示等功能。 图9. LLRF远程控制界面"
"本文结合D-BNCT01的加速器结构，提出并实现了低电平控制系统，包括腔体采样、变频计算、自动老炼、功率监测、功率保护等功能，满足D-BNCT01运行的需求。采用了自动变频、减少闭环带来的不稳定因素，采用VSWR实现快保护，响应速度达到微秒级别，采用前馈功能只对束流期间进行功率补偿，保证束流能量达到要求，实现了自动老炼功能，减少人工的干预和繁重的工作量。图10中绿色为四 图10. RFQ入腔功率与打靶功率的历史曲线 路入腔功率总和，蓝色为束流打靶功率。RFQ入腔总功率约490 kW，束流打靶功率4.3 kW。目前机器运行稳定，束流传输效率大于96%，已经多次给相关合作单位提供实验条件。"
