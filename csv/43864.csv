"为配合所设计柔性心电监测系统的下位机部分，设计一种心电数据处理系统，基于LabVIEW编程实现心电信号采样数据的分析。按照规定的协议，下位机通过蓝牙/串口将采集到的数据传输至上位机，上位机完成心电信号的数据可视化、实时测量心率、血氧饱和度以及体温等生理参数，对心电波形进行数字滤波处理、保存心电数据、读取二进制文件数据并重绘心电波形图。经分析测试，软件使用成本低、稳定性较好，基本实现用户短距离实时心电监测。"
"现如今随着经济水平的提高，大众关注的重点从物质生活的满足上逐渐转移到自身健康的质量上，在日常生活中监护自己身体状况的需求日渐增多。心血管病负担日益加重，已成为重大的公共卫生问题，防治心血管病刻不容缓 [ 1 ]。 监测心电信号可以帮助人们及时发现病症的存在，但是目前大多数心电监测模块使用下位机屏幕显示心电波形，这使得心电监测具有很大的局限性，实时监测难度大。LabVIEW是虚拟仪器领域中最具有代表性的图形化编程开发平台 [ 2 ]，主要应用于仪器控制、数据采集、数据分析、数据显示等领域，并适用于多种不同的操作系统平台 [ 3 ] [ 4 ]。本文基于LabVIEW设计了心电采集上位机软件，下位机可通过无线数据传输将数据传输至上位机，完成心电波形绘制和参数显示，实现了心电采集与监测分离以及无线生理参数实时监测，增强了各部分独立性，可供用户日常连续准确的监测动态心电。借助LabVIEW编程简单直观、易于理解等特点实现了帮助人们简便易操作的了解自己心脏的状况，并记录和保存心电数据以便发现病症后医生的专业分析。"
"软件整体分为数据通信、数据解析、数据处理、数据存储与读取四部分，整体流程图如图1所示。 下位机程序调试完成后进行心电数据采集并与上位机通讯，上位机数据接收部分可实现串口配置和蓝牙虚拟串口/串口数据接收；数据解析可对下位机发送的数据按照规定协议进行分类解析并存入数据缓冲区；数据处理将数据缓冲区的数据进行滤波处理并显示心电波形；数据保存可让用户将接收的心电数据以.csv的格式存储在磁盘中；读取文件部分可实现对本地二进制文件进行读取，并将文件中的数据重构心电波形。LabVIEW前界面如图2所示。"
"本设计可实现蓝牙虚拟串口通讯或直接与串口通讯，蓝牙虚拟串口即蓝牙与PC进行连接后，PC的COM端口可自动虚拟出一个传入端口和一个传出端口。下位机可通过传出端口与上位机进行串行通信，可简化蓝牙通讯的复杂度完成无线通信。 图1. 系统流程图 图2. LabVIEW前面板设计 软件通过调用VISA Config Serial Port完成串口参数设置 [ 5 ]，默认8个数据位，1个停止位，无奇偶校验位，用户可通过前界面下拉列表自主设置波特率与下位机匹配。下位机蓝牙与PC蓝牙配对后，在上位机选择虚拟的端口号，打开串口，上位机与下位机进行无线通信 [ 6 ]，进行数据接收，设计源码如图3所示。 图3. LabVIEW串口配置源码  接收的每一帧数据可分为两部分：数据头和是有效数据位。数据接收利用向量机原理，将接收数据头和接收有效数据位分为两个状态：接收数据头状态、接收有效数据位状态，如图4所示。软件运行后进入接收数据头状态，当串口数据缓存区大于等于10个字节时，上位机判断前两个字节数据是否为帧头。如果是则接收十个字节的数据头存储在变量中用于数据解析，接收完成后进入接收有效数据位状态，按照规定数据长度接收一定长度的数据存储在数据缓冲区中，用于数据处理。 图4. 上位机状态图  接收到的数据需要按照一定的规则进行解析，数据头是数据解析的基本协议，本设计采用前十个字节数据，每个字节是一个八位无符号数进行协议规定，如表1所示，接收数据头LabVIEW源码如图5所示。 Table 1 数据头 协议规定 详细解释 第1、2个字节 每帧数据的开头 下位机发送的每一帧数据必须以特定的数据开头，即帧头与上位机匹配，数据才会被上位机解析。 第3个字节 规定数据类型 下位机发送不同的值告诉上位机有效数据位的数据类型，如：发送0x00代表有效数据位是无符号8位数。 第4个字节 选择上位机模式 上位机有两种模式：如果下位机该字节数据发送0x01，上位机为波形模式，有效数据位必须是心电数据才能被正确解析画图；如果下位机该字节数据发送0x10，上位机为数据模式，有效数据位必须是其他生理参数才能被正确解析显示在界面文本框内。 第5、6个字节 规定有效数据位长度 下位机发送不同数值代表不同的数据长度，告诉上位机每一帧数据一共包含多少个字节的数据。 第7～10个字节 采样率设置 不同的值代表不同的采样率，告诉上位机心电信号采集时的采样率，采样率匹配用于心电信号数字滤波。 表1. 通信协议说明 图5. Labview接收数据图 上位机从串口缓冲区读取有效数据位，有效数据位需按照协议头规定的数据格式、数据长度进行发送才能进行正确解析，解析方法可以通过自定义控件来实现如图6(a)~(c)所示，解析过后的心电数据存储在数据缓冲区中，如图6(c)所示。"
"LabVIEW是并行执行软件，在接收数据的同时可以进行数据处理。本设计将数据处理部分与数据接收部分分离，提高系统的独立性。通过定时循环结构循环读取数据缓冲区中的数据，将数据从数组中依次取出，在波形图表直接显示原始波形。为滤除心电信号中的干扰，设计一个反切比雪夫二阶低通滤波器，由于心电信号频谱范围主要分布在0~40 Hz [ 7 ]，所以设计截止频率为30 Hz，滤波后的数据可通过波形图表显示滤波后的波形，设计源码如图7所示。 图6. 数据解析。(a) 自定义数据解析控件；(b) 数据解析源码；(c) LabVIEW接收有效数据位源码 图7. LabVIEW数据处理设计源码"
"上位机接收到的数据可通过文件对话框控件以.csv的格式存储到本地磁盘中，方便用户查看和进行后续数据处理，保存串口数据源码如图8所示。 图8. LabVIEW保存数据源码  上位机可读取本地路径下的二进制文件，对于二进制整型数据文件，因为整型数据是与二进制严格一一对应的，可以将文件读出后，通过字节换序得到正确的数据 [ 8 ]。本设计将二进制文件中的每两个字节二进制数还原一个十进制数，并在波形图标中绘图，文件读取源码如图9所示。 图9. LabVIEW二进制文件读取源码"
"本实验下位机采用STM32F103开发板与ADS1292模块进行心电信号采集，通过蓝牙虚拟串口与上位机无线通讯，分别测试心电信号发生器和人体心电信号，测试结果如图10(a)、图10(b)所示，读取二进制心电数据文件可以完整绘制心电波形，如图所示图10(c)所示。 图10. 上位机界面。(a) 心电信号发生器测试结果；(b) 人体心电信号测试结果；(c) 读取二进制文件重构波形"
"本文设计并实现了基于LabVIEW的心电采集上位机软件，可与下位机进行无线通讯，使信号采集和监测相独立，提高了系统的整体实用性。经分析测试，软件使用成本低、稳定性较好，可基本实现用户短距离实时心电监测、读取心电数据文件并重绘心电波形的功能，可用于简易心电信号采集的项目开发中，而且LabVIEW参数具有可调控性，数据使用方便、人机交互能力强、具有良好的可扩展性。"
