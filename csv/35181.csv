"为提高传统小电流接地故障检测系统在面对复杂环境时，其数据传输的可靠性和及时性，本文提出以CAN总线协议结合令牌环网作为系统的传输方式。CAN总线的应用可以提高系统对数据传输的速率，从而提高系统的数据吞吐量和对故障的反应能力。令牌环网则作为一种局域网协议，可以处理环网上多节点数据传输冲突的问题，有效改善系统的信道堵塞。本设计使用以STM32F407为核心处理器，对数据的输入存储和输出控制进行总体调配，并且对故障数据快速进行处理分析，得出正确的故障选线结果，保护电网设施。 关键词 :CAN总线协议，故障选线，令牌环网，STM32F407处理器 Copyright © 2020 by author(s) and Hans Publishers Inc. This work is licensed under the Creative Commons Attribution International License (CC BY 4.0). http://creativecommons.org/licenses/by/4.0/"
"随着我国农村电网改造工程的开展，其配电系统所发生的故障中，如导线断线、绝缘子击穿、树木短接等原因导致的单相接地故障占到了80% [ 1 ]。如果配电系统出现小电流接地故障，电网可能会产生严重的安全事故。因此对小电流接地故障的快速检测、快速反应是保证电网安全的重要举措。 CAN (Controller Area Network)总线虽最早是面向汽车行业推出的串行通信协议，但因其高性能和可靠性已被普遍认同，广泛应用于工业自动化、船舶等方面；具有数据吞吐量大，传输速率快，可靠性强和传输距离远等优点。 在系统中，如果仅使用CAN总线的方式定义各分支点的优先级级别进行数据传输，优先级级别低的节点会让优先级级别高的节点数据传输完成后再进行传输，这就可能造成数据传输堵塞的情况。在堵塞很严重的情况下，可能优先级级别低的数据帧很难得到发送权，而使得无法保证系统数据的实时性。通过CAN总线传输数据有一个著名的“Last-But-One-Bit”错误，在对实时性要求比较高的多分支系统中，可能会造成其系统性能下降或者其他严重错误。因此可以结合令牌环网的特点进行互补，改善其在系统的性能。 令牌环网(Token-ring network)是IBM公司于二十世纪八十年代开始发展，现今仍具有重要意义。其在老式环网中的传输速度为4 Mbps或16 Mbps，而新型的环网速率则达到了100 Mbps。它的传输方法在物理上可以使用星形拓扑结构，但在逻辑上仍是环形拓扑结构。 令牌环网是将各个分支连接一个环上，分支只能向直接相邻的分支传输数据，每个分支只有获得令牌后才能进行数据发送，也就不存在数据发送冲突的问题。我们通过在CAN总线的应用层上定义这种令牌形式的帧，通过令牌进行数据发送协调，分支拥有同等的权利发送数据。如果环网上的令牌丢失则会导致整个环网的数据传输终止，因此系统需要专门对令牌进行维护。"
"本设计中的小电流接地故障检测系统是以STM32F407处理器为核心，配备人机交互模块、数据存储模块等外设，以便于工作人员实时查看系统状态，在发现问题后及时对系统调试，使得系统正常运行。系统总体结构示意图如图1。 系统的主要工作流程为： 图1. 检测系统结构图 (1) 数据采集分支器对采集到的数据进行分析，初步判断故障信息。对数据简单处理后向上位机发送故障消息。 (2) 上位机收到故障消息后通过广播的方式要求各个分支器保存当前数据，并发送给上位机。 (3) 上位机保存收到的数据并对数据进行处理分析，采用多种算法综合估算可能性最大的故障线路。 (4) 上位机通过显示器显示具体故障信息，通过报警装置提醒工作人员进行处理，且输出控制信号对故障线路采取措施，保护电网。 其中对于故障选线的判断可采用“基波比幅比相算法”、“五次谐波算法”，“基于负序过电流和负序过电流突变量判据” [ 2 ] 等理论分析方法，综合判断故障线路。"
"每个数据采集分支器都以STM32F407为核心处理器，通过高精度零序电流互感器对所负责的三相电路中的A、B和C三相的数据进行采集。数据采集装置需要对数据进行预判断，判断有错后再将错误上传。当配电网正常工作时，其三相电对称，三相电流的向量和为0；在三相中发生接地故障后，会导致电流的向量和不为0，可以以此作为判断故障的简单依据。在判断中应该结合实际情况设定一定的向量和阈值，以消除外界环境导致的干扰。数据采集模块图如图2所示。 图2. 数据采集模块结构图"
"此模块主要是基于CAN通信方式进行各分支的数据传输，其中STM32F407处理器中内置CAN控制器，只需通过连接一个收发器即可完成CAN通信。本设计采用的是ISO1050隔离式CAN收发器芯片，并搭配外围滤波降噪电路的CAN收发器电路。电路图如图3所示： 图3. CAN收发器电路图   令牌环网是一种以环形网络拓扑结构发展起来的局域网协议，其通信介质可以是双绞线、光纤等。通过特有的令牌在环状网的各个结点进行逐次传输，谁持有令牌就可以通信 [ 3 ]。这种方式实现对信道的单一使用，可以有效避免信道拥堵的情况。它也使得系统即使在负载很重的条件下也能够有准确的响应时间，并且很适合在高数据吞吐量的多分支系统中使用。主要原理图如图4所示。 图4. 令牌环网工作原理图 令牌环网主要有两种帧结构，一种是载有数据的数据帧，一种是令牌。其中令牌是一种特殊的帧，用于在环网中依照节点序号进行依次传输，以确定占用信道的节点，因此每个节点都有均等的访问权。而对于数据帧来说，主要是节点在持有令牌后，通过修改目的地址和加上数据等对令牌进行改造，从而传输数据。具体帧格式如图5所示。 令牌中的帧首定界符和访问控制域是捕获到令牌的节点在帧的起始位置所创建的，而帧尾定界符放置在帧的末端，表明帧的结束。访问控制域包含优先级机制(及特定的节点序号)和预留比特及监控比特，也用于区分是令牌还是数据帧。目的地址和源地址用来表明地址信息；帧校验序列用来检测帧的正确性；帧状态域表明帧是否被目的地点接收。 图5. 数据帧和令牌的格式  令牌环网技术的基础是使用了叫做令牌的特定比特串，当环上所有节点都空闲时，则令牌沿着环旋转；当节点有数据需要传输时，则等令牌到达节点并“抓住”令牌，才能进行数据传输。此时需将令牌由空闲状态改为忙碌状态，即将令牌的访问控制域中的令牌域置“1”。并将其余的字段都放在帧首序列之后，形成一个完整的发送帧，原来令牌的帧尾定界符被吸收。 等到节点数据发送完成或者令牌保持计时器超时 [ 4 ]，忙碌的令牌会根据其设定的目的地址寻找接收节点。对于此系统，接收节点即为上位机，因此只需设定所有目的地址都为上位机地址即可。上位机接收完成后会以报文的形式做出应答，此时令牌会回到原始节点，原始节点抹掉数据并将令牌改为空闲状态，令牌就被传递到下一个节点，即可完成环网的数据传输。  CAN总线是一种共享式总线，我们可以在总线协议的应用层上定义一个类似的令牌。这里可以使用CAN协议帧仲裁段，其主要作用是处理对于数据传输冲突的优先级判断。结合令牌环网的特点，我们可以将其作为节点顺序标识和有无数据传输标识。 对于标准帧格式其帧仲裁段标识符为11位，而扩展帧格式为29位；这里只需采取标准帧格式既可满足系统需求。将11位标识符高10位作为节点顺序标识，后一位作为数据传输标识。如图6所示： 图6. ID段划分 通过将节点顺序标识分配给各个结点，即可控制其令牌的循环走向。而数据传输标识则是可以快速判断是否有数据发送，节省令牌停留在无数据发送节点上的时间。通过最初判断是否有数据传输可以将时间进一步缩小，因此实际周期要小于或等于T。其分配图为如图7中(a)图。在对于数据传输需求较多的节点，还可以适当增加这个节点在总线中的信道占用时间。即通过在一个循环周期内，增加这个节点持有令牌的次数，如图7中(b)图所示。为了更好利用带宽，还可以根据当前节点的实时消息的负载情况来动态分配网络带宽，进一步合理使用网络带宽 [ 5 ]。 图7. 总线占用图  令牌环网可以很好地解决数据传输冲突的问题，但如果在令牌传输时，某一节点故障导致令牌丢失，则可能导致后面的节点都无法传输。这就需要有令牌协议具有一定的容错措施 [ 6 ]，去解决这些错误。 这里需要定义一个优先级最高的帧，主要作用是进行总线复位，以广播的方式进行发送，在每个节点上设置一个计时器，当接到令牌后开始计时，如果超过某一个时间还没有将令牌释放，认为发生故障，则发送复位帧并进行总线复位，可以将时间设定为3 t，并进行错误次数统计。当再次经过此节点时计时器重新计时，如果此时节点正常通过令牌，则清零错误次数。如果错误次数达到设定次数，此时可认为这个节点故障无法恢复，在下个周期跳过此节点 [ 7 ]。"
"本文通过结合令牌环网的优势和CAN总线传输的优势，为小电流接地故障检测系统提供快速、稳定、可靠的数据传输方式。令牌环网通过“令牌”提供给节点数据传输权限，为信道提供唯一不冲突的数据提供源，可以有效避免因信道堵塞造成的数据传输延迟。CAN总线则可以为系统提供快速和可靠的数据传输，提高了系统的分支容纳量和数据吞吐量。"
