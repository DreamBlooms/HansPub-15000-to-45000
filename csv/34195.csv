"本文针对传统手工花卉浇灌方式工作效率低下、现有智能花盆存在机电分离、布线混乱以及远程监控能力不足等问题，应用分布式架构与一体化设计理念，基于STM32F103控制器，结合Unity3D引擎开发上位机，设计和研制了一种分布式一体化远程智能花盆。该系统由底层服务端和远程客户端两部分组成。底层服务端包括从机和主机：从机使用土壤湿度传感器、空气温湿度传感器以及环境光传感器实时检测土壤湿度、室内环境温湿度和光照强度；主机根据不同的程序设定进行不同的命令控制，最终实现远程控制、自动浇灌、降低成本以及等机电一体化目的。远程客户端采用彩色界面模拟现实绿植状况，与底层服务端通过透传云进行通讯，具备浇水手自动模式调换和花草数据实时显示功能。 关键词 :分布式系统，远程监控，智能花盆 Copyright © 2020 by author(s) and Hans Publishers Inc. This work is licensed under the Creative Commons Attribution International License (CC BY 4.0). http://creativecommons.org/licenses/by/4.0/"
"伴随物联网时代的到来和人们生活水平的提高，绿植花卉成为美化家居环境、治理环境污染的有效手段。绿植花卉养护多采用传统手动浇灌方式，浇水周期不规律，有时因为公务繁忙或者长时间出差在外，花草疏于照顾甚至枯死。虹吸式供水的简易浇花装置或者定时定量浇水的自动浇花器，一定程度上缓解了长时间无人浇花的问题，但缺乏对植物生长环境参数的有效监控。基于集成电路设计的各类智能浇花系统，多采用微控制器作为控制芯片，利用土壤湿度、光照等传感器检测植物生长环境参数，根据植物生长特性设置参数阈值，通过控制继电器和水泵等，自动完成浇灌任务 [ 1 ] [ 2 ] [ 3 ]。目前，具有远程监视、控制、虚拟现实等功能的花卉养护系统也屡见公开报道 [ 4 ] [ 5 ]，此类系统中植物盆景和自动浇花装置彼此分离，工作时需要根据盆栽植物大小和分布，需要人工分配水管和传感器的位置。由于传感器和控制器之间多采用有线的连接方式，导致系统安装过程复杂、系统灵活性和可靠性低，当盆栽稍多时，实用性不强。 智能花盆作为一种新兴智能家居设备，成为住宅和办公室环境美化的新宠 [ 6 ]。法国Parrot公司于2016年推出了Robotic Plant Pot智能蓝牙节水花盆，采用蓝牙无线技术，进行短距离数据交换，但是该系统不能实现远程监视和控制 [ 7 ]。2014年北京交通大学机械与电子控制工程学院的张鑫等人设计了一种基于Kinect的智能花盆体感控制系统，可通过人体动作实时控制花盆系统的布景图案 [ 8 ]。此外各种具有独特功能的智能花盆也是层出不穷，例如水箱容积与电池电量较大的Just Grow智能花盆。但是，目前智能花盆多采用独立工作模式，联网花盆也仅限于本地局域网，大部分没有远程监视与控制功能。 针对自动浇灌装置和植物盆景分离，传感器和控制器布线混乱，输水管线容易跑冒滴漏，从而导致智能浇花系统安装和维护困难的问题，本设计采用一体化设计理念，开发了一种分布式一体化远程智能花盆，将整个自动浇灌装置集成到花盆内部；改变常规智能花盆的独立工作模式，采用分布式理念，增加了花盆监控通信中心，该通信中心可以连接到多个花盆自动浇灌装置并通过公用移动网络连接到远程花盆监控服务客户端系统，从而提供远程监控服务，将独立工作模式扩展为远程联网工作模式；系统中通信均采用无线通信技术，避免布线困难问题，消除了花盆摆放位置的局限。通过本系统，用户通过客户端系统可联网远程监控每个植物盆景的光照、土壤温湿度和空气温湿度等植物生长环境信息，可根据特定植物需求特征设置生长环境参数进行自动浇灌，实现个性化养护。"
"系统总体结构图如图1所示，系统包括一体化自动浇灌智能花盆、 花盆监控通信中心和远程花盆监控服务客户端组成。 图1. 系统总体结构图 一体化自动浇灌智能花盆包括花盆机械本体和自动浇灌装置两个部分。其中花盆机械本体是一个含有水箱和输水软管，且预留了安装自动浇灌装置空间的一体化智能花盆。自动浇灌装置包括控制器、蓄电池、抽水水泵、环境光传感器、空气和土壤温湿度传感器。自动浇灌装置通过传感器采集植物盆栽生长环境参数，根据预设浇灌策略实现自动浇灌功能；另外，自动浇灌装置带有2.4 GHz无线通信接口，可通过花盆监控通信中心连接远程花盆监控服务客户端实现更丰富和个性化的功能。自动浇灌装置可便捷地安装到花盆机械本体内部预留位置，解决了目前市场上智能花盆机电分离的问题。 花盆监控通信中心是一个以微控制器为核心的花盆通信控制网关。该网关一方面通过2.4 GHz无线通信可与多个一体化自动浇灌智能花盆组成私有无线通信网络，另一方面，使用GPRS通信接入公用移动通信互联网，使得远程花盆监控服务客户端通过互联网接入花盆私有无线通信网络，从而解决了目前市场上智能花盆无法远程操控的问题。 远程花盆监控服务客户端包括手机端和PC端。客户端通过互联网读取植物盆栽生长环境参数、设置自动浇灌工作模式和工作参数等，从而实现对一体化智能花盆的远程监视和控制，提供丰富和个性化的功能。应用程序开发使用了Unity3D引擎，通过彩色界面模拟现实绿植状况，实现人机交互，使用户体验更形象和舒适。"
"考虑到放置智能花盆的体积问题，本设计根据办公室、家居的常用小盆花所需花盆大小进行设计，整个花盆的大小适合日常需求。此外，设计花盆时考虑了工厂批量生产。一体化智能花盆的设计过程如下：采用Solidworks进行三维建模，通过3D切片进行3D打印生产出一体化花盆样品。一体化花盆有三个零件，分别为底座零件、水箱零件、花盆零件，零件图分别如图2、图3、图4所示。 图2. 底座零件图 图3. 水箱零件图 图4. 花盆零件图 将自动浇灌装置中蓄电池和控制器部分粘贴于底座上，将土壤湿度传感器插入20X2.5的插槽，将花盆的4Xϕ5柱对应插入4Xϕ5插槽中。将上述装配体从上放入水箱上，并将抽水水泵放入水箱，其中花盆的ϕ118表面与水箱的ϕ118表面配合。"
"在自动浇灌装置中，控制器是核心，该控制器是一个以微控制器为核心元件的智能电子测控系统，图5是自动浇灌装置控制器的硬件原理图。 核心元件微控制器使用了意法半导体(ST)公司以32位ARM内核为核心的STM32F103芯片，该微控制器低功耗、运行速度快、外围接口丰富和价格低廉等优势，完全符合产品化设计的要求。 控制器可以采集光照强度、土壤温湿度和空气温湿度共五个环境参数，为此选用了BH1750集成数字光照传感器模块、DHT11数字温湿度传感器模块和土壤型温湿度传感器模块SHT10。 BH1750集成数字光照传感器模块的光照度范围为0~65535勒克斯，传感器内置16为AD转换器直接数字输出，提供IIC串行总线接口。DHT11数字温湿度传感器模块的湿度测量范围为20%~95%，温度测量范围为0℃~50℃，提供一线制数字输出接口。土壤型温湿度传感器模块SHT10的湿度测量范围0%~100%，温度测量范围−40℃~123.8℃，可将其探头直接埋入土壤中，提供两线数字串行接口。设计中三种传感器均连接3.3伏供电，数字接口管脚连接到微控制器的通用IO管脚。 控制器选用了nRF24l01无线通信模块作为2.4 GHz无线通信接口，提供了SPI接口与微控制器连接。小水泵选用5 W功率12伏直流小水泵，该水泵扬程1.2米，微控制器IO管脚通过PNP三极管8550进行功率放大后开关控制小水泵。 图5. 浇灌控制器硬件原理图 图6. 浇灌控制器软件主程序流程图  浇灌控制器软件主流程如图6所示，其中系统初始化包括微控制器的外设接口初始化、存储器初始化和浇灌模式及控制参数初始化等。主循环依次进行传感器数据采集、浇灌处理、数据通信处理。传感器数据采集部分程序只需根据相应的产品手册按通常方法编写即可。浇灌处理按照浇灌模式可自动浇灌或手动浇灌。在自动浇灌模式下，若土壤湿度小于用户设定湿度阈值，则接通水泵进行浇水；若土壤湿度大于等于用户设定湿度阈值，则断开水泵停止浇水。在手动浇灌模式下，程序根据远程花盆监控服务客户端设定的启停参数控制水泵。 数据通信程序包括两部分，一部分在无线通信模块中断处理程序中，进行接收数据帧和发送数据帧的处理；另一部分在程序主循环中，进行接收数据帧的解析并执行，发送数据帧的装配及启动发送。"
"每一个不同的从机设有不同的沟通密码key和沟通通道Rd。主机在自动模式中按照顺序循环发送沟通密码，循环接收不同从机的实时数据存储于各个从机的接收数据包中。当主机在手动模式时，根据用户点击选择的特定花卉发送对应从机的沟通密码，并接收本机实时数据包，显示给用户。 主机通讯实现如下： //主机通讯子函数 void Communicate(u8 Rd, u8 key) {NRF24L01_TX_Mode(); //设置RF通道为Rd进行通讯 NRF24L01_CE=0; NRF24L01_Write_Reg(WRITE_REG_NRF+RF_CH,Rd); NRF24L01_CE=1; rece_buf[ 0 ]=key; while(NRF24L01_TxPacket(rece_buf)!=TX_OK) delay_ms(10); NRF24L01_RX_Mode(); NRF24L01_CE=0; NRF24L01_Write_Reg(WRITE_REG_NRF+RF_CH,Rd); NRF24L01_CE=1; while(NRF24L01_RxPacket(tmp_buf)!=0) delay_ms(10);……//接收处理数据 } int main(void) {Communicate(10,0x66);//调用通讯子函数 Communicate(40,0x88);…… } 从机通讯实现如下： //设置RF通道为10进行通讯 NRF24L01_RX_Mode(); while(NRF24L01_RxPacket(rece_buf)!=0) delay_ms(10); if(rece_buf[ 0 ]==0x66) {NRF24L01_TX_Mode(); ……//读取传感器数据并处理 while(NRF24L01_TxPacket(tmp_buf1)!=TX_OK) delay_ms(10); }  本主机应用485通信、通过串口与GPRS模块连接，GPRS模块进行调试，接入透传云节点，应用外通讯网络连接手机的客户端。同样的，手机客户端也可以通过透传云向主机端发送数据，从而实现了命令、数据包的相互传输。 主机串口通讯实现如下： void USART1_IRQHandler(void) //串口1中断服务程序 {u8 Res=0,Num=0; if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)//接收中断 {USART_ClearITPendingBit(USART1,USART_IT_RXNE); Num=USART_ReceiveData(USART1); //读取接收到的数据 if(Num==1) rece_buf[ 0 ]=0x66; if(Num==2) rece_buf[ 0 ]=0x88; //对不同的花盆代号修改不同的沟通密码 if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET) {USART_ClearITPendingBit(USART1,USART_IT_RXNE); Res=USART_ReceiveData(USART1);} if(Res=='A') printf(Airtemp:%d Airhumid:%d Soilhumid:%d Light:%d,airtemp[Num],airhumid[Num],soilhumid[Num],light[Num]); if(Res=='B') rece_buf[ 1 ]='B'; if(Res=='C') rece_buf[ 1 ]='C'; if(Res=='D') rece_buf[ 1 ]='D'; if(Res=='E') rece_buf[ 1 ]='E';} }  主从机通信流程图如图7所示，主机首先向外发送沟通密码，以避免杂乱信号的干扰。这时，从机一直处于准备接收的模式，如果接收到沟通密码与本机沟通密码一样，即沟通对接成功，从机将立即将本机所采集的数据包打包，通过某一特定通道发送给主机，主机接收数据包并处理存储于各数据存储空间中，等待进行下一步任务。此时，从机回复准备接收模式。 图7. 主从机通信流程图"
"远程花盆监控服务客户端采用Unity3D引擎开发，该平台具有运行稳定、开发效率高等特点。通过Photoshop对图片进行编辑、修剪、加工，得到背景图案以及按钮标志。以C#.Net作为开发的脚本语言，应用Unity3D原有的Monodevelop脚本编辑器完成对透传云数据信息的导入、实时信息显示以及远程控制等具体操作。最终根据所需的操作系统进行应用导出。客户端实现了对植物盆栽环境状态的实时监控、远程浇灌、人机交互等功能。用户可以通过客户端软件进行连接网络、断开网络、查看数据、模式选择、浇灌、停止浇灌等等操作。 以手机端为例，上位机远程客户端界面如图8所示。用户可以自定义植物盆栽名称、浇灌模式，还可以在显示区了解植物盆栽的各种数据。 图8. 手机端远程客户端界面 用户点击界面左下角的图标可以进行上位机透传云通讯的配置，点击界面右上角的图标可以进行上位机透传云通讯的断开并关闭上位机，在用户不使用上位机的时候减少流量开支。用户点击某一朵特定的花卉时，客户端可远程读取花卉环境数据，并在显示界面的数据框中显示如下数据：花盆代号、光照强度、土壤湿度、空气温度、空气湿度。用户点击自动模式可远程设置相应花盆浇灌模式为自动浇灌模式，同时用户可以设定自动浇灌模式的土壤湿度阈值。用户点击手动模式可远程设置相应花盆浇灌模式为手动浇灌模式，此模式下用户点击浇灌图标可针对相应花盆启动和停止浇灌动作。"
"将自动浇灌装置组装到一体化花盆中，并配置好自动浇灌装置、花盆监控通信中心和远程花盆监控服务客户端，系统中实物组件如图9所示，从左到右依次为：花盆监控通信中心内部、花盆监控通信中心外表、一体化自动浇灌智能花盆。 图9. 系统实物组件图 系统测试了手动模式和自动模式的浇灌情况，其中浇灌土壤的水分数据图如图10所示，共测试15个测试点，水分越充足颜色越深。根据测试数据，发现一体化智能花盆的浇灌设计方式导致土壤浇灌不均匀，以花洒为中心，越接近花洒浇灌后水分越高，需在一体化智能花盆的整体设计上进行改进。 图10. 浇灌后土壤水分分布图"
"分布式一体化远程智能花盆系统解决了自动浇灌装置和花盆机械本体的一体化集成设计问题，减小了智能花盆的放置空间，降低了智能花盆的人工配置和维护成本；系统通过花盆监控通信中心和远程花盆监控服务客户端实现了智能花盆的联网远程操控功能，同时提供了许多丰富和个性化的操作功能。样机系统经测试验证，达到了设计要求，具有较好的市场前景。可在该智能花盆的基础上进一步设计花盆滴灌控制装置，以解决土壤浇灌方式不均匀的问题。"
